#!/bin/bash
#
#======================================================================
# ROMS_AGRIF is a branch of ROMS developped at IRD and INRIA, in France
# The two other branches from UCLA (Shchepetkin et al) 
# and Rutgers University (Arango et al) are under MIT/X style license.
# ROMS_AGRIF specific routines (nesting) are under CeCILL-C license.
# 
# ROMS_AGRIF website : http://www.croco-ocean.org
#======================================================================
#
#---------------------------------------------------------------------
# Script to Run CVTK DEBUG procedure managing parallelization type 
# AND AGRIF nesting type (No nesting, Nesting 1-way, Nesting 2-ways) : 
# VORTEX and REGIONAL
#--------------------------------------------------------------------
#MPIRUN=$MPI_LAUNCH
echo " "
echo "======== BEGIN CVTK TEST PROCEDURE ==========="
echo " => CONFIG "$mytest
echo " "
echo "=> MPIRUN COMMAND: "$MPIRUN
echo "Remove *.exe* *.log* "
[ ! -z "$(ls *.exe* 2>/dev/null)" ] && /bin/rm *.exe*
[ ! -z "$(ls *.log* 2>/dev/null)" ] &&/bin/rm *.log*
echo "Remove the CHECKFILE"
[ -f check_file ] && /bin/rm check_file
echo "Remove AGRIF_FixedGrids.in"
/bin/rm -f AGRIF_FixedGrids.in 
echo " " 

#=============================================================================================
# Sources
#
sed -n -e '/SOURCE=/p' jobcomp_rvtk.bash_v1 > tmp1
sed -n '$p' tmp1 > tmp2
eval "SOURCE=`sed -n -e '/SOURCE=/ s/.*\= *//p' tmp2`"
rm -f tmp1 tmp2
echo 'Sources code: '$SOURCE
echo

SOURCE_CVTK=${SOURCE}/../CVTK/test_repro/RVTK_DEBUG_src
echo 'Sources CVTK tests: '$SOURCE_CVTK
echo ' '
#
# Get updated files
#
#/bin/cp ${SOURCE_CVTK}/Config_files/cppdefs_dev_cvtk.h cppdefs_dev_bak1.h.OPENMP
/bin/cp ${SOURCE_CVTK}/Config_files/cppdefs_ana_cvtk.h cppdefs_bak1.h.SERIAL
/bin/cp ${SOURCE_CVTK}/Config_files/param_cvtk.h param_bak0.h.SERIAL

/bin/cp ${SOURCE_CVTK}/Config_files/cppdefs_ana_cvtk.h cppdefs_bak1.h.OPENMP
/bin/cp ${SOURCE_CVTK}/Config_files/param_cvtk.h param_bak0.h.OPENMP

/bin/cp ${SOURCE_CVTK}/Config_files/cppdefs_ana_cvtk.h cppdefs_bak1.h.MPI
/bin/cp ${SOURCE_CVTK}/Config_files/param_cvtk.h param_bak0.h.MPI
#

source configure_file

##############################################################################
#
#   FILL THE CPPDEFS.H 
# Title
echo TESTS OF $LIST_CONFIG
#
# 1- UNDEF ALL THE KEYS
#
echo 'undef '$LIST_KEY0
for par in SERIAL OPENMP MPI ; do 
    echo 'PARA=' $par
    for EXAMPLE in $LIST_KEY0
    do
	sed 's/'define\ \ \*$EXAMPLE'/'undef\ $EXAMPLE'/' < cppdefs_bak1.h.$par > cppdefs_bak2.h.$par
	/bin/mv cppdefs_bak2.h.$par cppdefs_bak1.h.$par
    done
    
    # 2- DEFINE THE TYPE OF DEBUG TEST 
    sed 's/'undef\ \ \*$KEY_DEBUG'/'define\ $KEY_DEBUG'/' < cppdefs_bak1.h.$par > cppdefs_bak2.h.$par
    /bin/mv cppdefs_bak2.h.$par cppdefs_bak1.h.$par
    
    
    # 3- DEFINE THE NAME OF THE CONFIG
    sed 's/'undef\ \*$CONFIG_NAME'/'define\ $CONFIG_NAME'/' < cppdefs_bak1.h.$par > cppdefs_bak2.h.$par
    /bin/mv cppdefs_bak2.h.$par cppdefs_bak1.h.$par
    
    # 4- DEFINE THE VARIOUS CPPKEYS
    #=4.1
    for EXAMPLE in $LIST_KEY_PHYS
    do
	sed 's/'undef\ \ \*$EXAMPLE'/'define\ $EXAMPLE'/' < cppdefs_bak1.h.$par > cppdefs_bak2.h.$par
	/bin/mv cppdefs_bak2.h.$par cppdefs_bak1.h.$par
    done
    #==4.2
    for EXAMPLE in $LIST_KEY_NEST
    do
	echo $EXAMPLE
	sed 's/'undef\ \ \*$EXAMPLE'/'define\ $EXAMPLE'/' < cppdefs_bak1.h.$par > cppdefs_bak2.h.$par
	/bin/mv cppdefs_bak2.h.$par cppdefs_bak1.h.$par
    done
done

#=====================================================================================================
#=====================================================================================================
#####
echo 'FLAG OPENMP' ${FLAG_OPENMP}
echo 'FLAG MPI' ${FLAG_MPI}
####
echo ' '
echo '==============================='
echo ' START TESTING ...             '
echo '==============================='

# 3- 
##############################################################################
# Serial runs
##############################################################################

echo ''
par1='SERIAL'
echo "SERIAL NPP=1 TEST $mytest"
[ -f check_file ] && /bin/rm check_file
sed 's/'NSUB_X=1,\ \ \*NSUB_E=NPP'/'NSUB_X=1,\ NSUB_E=1'/' < param_bak0.h.$par1 > param_bak1.h.$par1
sed 's/'NPP=1'/'NPP=1'/' < param_bak1.h.$par1 > param_bak2.h.$par1
/bin/mv param_bak2.h.$par1 param_bak1.h.$par1 ; rm param_bak0.h.$par1

rm -Rf Compile_$par1 ; mkdir Compile_$par1
cp param_bak1.h.$par1 Compile_$par1/param.h.OK
cp cppdefs_bak1.h.$par1 Compile_$par1/cppdefs.h.OK

echo "qsub -h -N ${TEST_NAME}_SE comp_run_serial_KTEST.bash"
qsub -h -N ${TEST_NAME}_SE comp_run_serial_KTEST.bash
myjobid_serial="`qselect -N ${TEST_NAME}_SE -u $USER`"

# 3- 
##############################################################################
# Openmp runs
##############################################################################
if [ ${FLAG_OPENMP} = 1 ]; then 
 
if [ ${FLAG_OPENMP} = 22 ]; then    
    echo ' '
    echo "OPEN-MP 2X2 NPP=4 TEST $mytest"
    export OMP_NUM_THREADS=4
    par1='OPENMP'
    sed 's/'NSUB_X=1,\ \ \*NSUB_E=NPP'/'NSUB_X=2,\ NSUB_E=2'/' < param_bak0.h.$par1 > param_bak1.h.$par1
    sed 's/'NPP=4'/'NPP=4'/' < param_bak1.h.$par1 > param_bak2.h.$par1
    /bin/mv param_bak2.h.$par1 param_bak1.h.$par1 ; rm param_bak0.h.$par1
    
elif [ ${FLAG_OPENMP} = 12 ]; then
    echo ' '
    echo "OPEN-MP 1X2 NPP=2 TEST $mytest"
    export OMP_NUM_THREADS=2
    par1='OPENMP'
    sed 's/'NSUB_X=1,\ \ \*NSUB_E=NPP'/'NSUB_X=1,\ NSUB_E=2'/' < param_bak0.h.$par1 > param_bak1.h.$par1
    sed 's/'NPP=4'/'NPP=2'/' < param_bak1.h.$par1 > param_bak2.h.$par1
    /bin/mv param_bak2.h.$par1 param_bak1.h.$par1 ; rm param_bak0.h.$par1
elif [ ${FLAG_OPENMP} = 21 ]; then
    echo ' '
    echo "OPEN-MP 2X1 NPP=2 TEST $mytest"
    export OMP_NUM_THREADS=2
    par1='OPENMP'
    sed 's/'NSUB_X=1,\ \ \*NSUB_E=NPP'/'NSUB_X=2,\ NSUB_E=1'/' < param_bak0.h.$par1 > param_bak1.h.$par1
    sed 's/'NPP=4'/'NPP=2'/' < param_bak1.h.$par1 > param_bak2.h.$par1
    /bin/mv param_bak2.h.$par1 param_bak1.h.$par1 ; rm param_bak0.h.$par1
fi 

    sed 's/'undef\ \ \*${par1}'/'define\ ${par1}'/' < cppdefs_bak1.h.$par1 > cppdefs_bak2.h.$par1
    /bin/mv cppdefs_bak2.h.$par1 cppdefs_bak1.h.$par1
    
    rm -Rf Compile_$par1 ; mkdir Compile_$par1
    cp param_bak1.h.$par1 Compile_${par1}/param.h.OK
    cp cppdefs_bak1.h.$par1 Compile_${par1}/cppdefs.h.OK
    
    echo "qsub -N ${TEST_NAME}_OM -W depend=afterok:$myjobid_serial comp_run_openmp_KTEST.bash" 
    qsub -N ${TEST_NAME}_OM -W depend=afterok:$myjobid_serial comp_run_openmp_KTEST.bash
    
    echo ""myjobid_openmp=`qselect -N ${TEST_NAME}_OM -u $USER`""
    myjobid_openmp="`qselect -N ${TEST_NAME}_OM -u $USER`"
fi 

###############################################################################

# 4- 
##############################################################################
# Mpi runs
##############################################################################
if [ ${FLAG_MPI} = 1 ]; then 

if  [ ${FLAG_OPENMP} = 22 ]; then
    echo ' '
    echo "MPI 2X2 TEST $mytest"
    par1='MPI'
    sed 's/'NP_XI=1,\ \ \*NP_ETA=4'/'NP_XI=2,\ NP_ETA=2'/' < param_bak0.h.$par1 > param_bak1.h.$par1
    rm param_bak0.h.$par1

elif [ ${FLAG_OPENMP} = 12 ]; then
    echo ' '
    echo "MPI 1X2 TEST $mytest"
    par1='MPI'
    sed 's/'NP_XI=1,\ \ \*NP_ETA=4'/'NP_XI=1,\ NP_ETA=2'/' < param_bak0.h.$par1 > param_bak1.h.$par1
    rm param_bak0.h.$par1

elif [ ${FLAG_OPENMP} = 21 ]; then
    echo ' '
    echo "MPI 2X1 TEST $mytest"
    par1='MPI'
    sed 's/'NP_XI=1,\ \ \*NP_ETA=4'/'NP_XI=2,\ NP_ETA=1'/' < param_bak0.h.$par1 > param_bak1.h.$par1
    rm param_bak0.h.$par1
fi

    sed 's/'undef\ \ \*$par1'/'define\ $par1'/' < cppdefs_bak1.h.$par1 > cppdefs_bak2.h.$par1
    /bin/mv cppdefs_bak2.h.$par1 cppdefs_bak1.h.$par1
    
    rm -Rf Compile_$par1 ; mkdir Compile_$par1
    cp param_bak1.h.$par1 Compile_${par1}/param.h.OK
    cp cppdefs_bak1.h.$par1 Compile_${par1}/cppdefs.h.OK
    
    echo "qsub -N mpi_${TEST_NAME}_MP -W depend=afterok:$myjobid_serial comp_run_mpi_KTEST.bash"
    qsub -N ${TEST_NAME}_MP -W depend=afterok:$myjobid_serial comp_run_mpi_KTEST.bash
    
    echo "myjobid_mpi="`qselect -N ${TEST_NAME}_MP -u $USER`""
    myjobid_mpi="`qselect -N ${TEST_NAME}_MP -u $USER`"
fi

#########################################################################################################
# 5- Extract results
##############################################################################
#  runs
echo ' '
if [[ ${FLAG_MPI} = 1 &&  ${FLAG_OPENMP} = 1 ]]; then 
echo "qsub -N ${TEST_NAME}_EX -W depend=afterok:${myjobid_mpi}:${myjobid_openmp} extract_results_croco.bash_v1"
qsub -N ${TEST_NAME}_EX -W depend=afterok:${myjobid_mpi}:${myjobid_openmp} extract_results_croco.bash_v1

elif [ ${FLAG_OPENMP} = 1 ]; then 
echo "qsub -N ${TEST_NAME}_EX -W depend=afterok:${myjobid_openmp} extract_results_croco.bash_v1"
qsub -N ${TEST_NAME}_EX -W depend=afterok:${myjobid_openmp} extract_results_croco.bash_v1

elif [ ${FLAG_MPI} = 1 ]; then 
echo "qsub -N ${TEST_NAME}_EX -W depend=afterok:${myjobid_mpi} extract_results_croco.bash_v1"
qsub -N ${TEST_NAME}_EX -W depend=afterok:`qselect -N mpi_${TEST_NAME} -u $USER` extract_results_croco.bash_v1
fi
#########################################################################################################


qrls `qselect -N ${TEST_NAME}_SE`
