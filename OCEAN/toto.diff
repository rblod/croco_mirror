init_arrays.F
1089,1091c1089,1091
< !            rho_nbq_avg2(i,j,k)=1.
< !            ruext_nbq(i,j,k)=init
< !            rvext_nbq(i,j,k)=init
---
>             rho_nbq_avg2(i,j,k)=1.
>             ruext_nbq(i,j,k)=init
>             rvext_nbq(i,j,k)=init
1093,1094d1092
<             rv_nbq_ext(i,j,k)=init
< #if !defined M2FILTER_NONE
1096,1097d1093
<             rv_nbq_avg1(i,j,k)=init
< #endif
1098a1095,1096
>             rv_nbq_ext(i,j,k)=init
>             rv_nbq_avg1(i,j,k)=init
1102,1103c1100,1101
<            ! ruint_bak_nbq(i,j,k)=init
<            ! rvint_bak_nbq(i,j,k)=init
---
>             ruint_bak_nbq(i,j,k,1:2)=init
>             rvint_bak_nbq(i,j,k,1:2)=init
1113d1110
< #if !defined M2FILTER_NONE
1115d1111
< #endif
1118c1114
<            ! rwint_bak_nbq(i,j,k)=init
---
>             rwint_bak_nbq(i,j,k,1:2)=init
init_arrays_floats.F
lmd_vmix.F
lmd_wscale.F
main.F
42d41
< #include "nbq.h"
46d44
< #include "ocean2d.h"
263d260
< 
273,277c270
<         call set_depth (tile
< #ifdef NBQ
<      &      ,0
< #endif
<      & )
---
>         call set_depth (tile)
335,339c328
<         call set_depth (tile
< #ifdef NBQ
<      &      ,0
< #endif
<      & )
---
>         call set_depth (tile)
349,352c338
< C$OMP PARALLEL DO PRIVATE(tile)
<       do tile=0,NSUB_X*NSUB_E-1
<         call initial_nh(tile,1)
<       enddo	  
---
>       call initial_nh(1)
380a367
>       call initial_nh(2)
383,393c370
<         call initial_nh(tile,2)
<       enddo	  
< 
< C$OMP PARALLEL DO PRIVATE(tile)
<       do tile=0,NSUB_X*NSUB_E-1
<         call set_depth (tile,1)
<       enddo
<       
< C$OMP PARALLEL DO PRIVATE(tile)
<       do tile=0,NSUB_X*NSUB_E-1
<         call set_HUV (tile)
---
>         call set_depth (tile)
module_grid.F
module_ocean3d.F
module_param.F
module_scalars.F
mpc.F
mrl_wci.F
ncjoin.F
ncrename.F
nf_add_attribute.F
nf_fread.F
nf_fread_x.F
nf_fread_y.F
nf_read_bry.F
o2sato.F
obc_volcons.F
omega.F
online_bulk_var.F
online_get_bulk.F
online_interp.F
online_interpolate_bulk.F
online_set_bulk.F
output.F
partit.F
pre_step3d.F
98,100d97
< # ifdef NBQ
<       real qdm_nstp,qdm_indx
< # endif
120,126d116
< 
< #if defined NBQ && defined M2FILTER_NONE
< #define ru_nbq_avg1 ru_nbq_ext
< #define rv_nbq_avg1 rv_nbq_ext
< #define rw_nbq_avg1 rw_nbq_ext
< #endif
< 
208,211d197
< !            Hzr_half_nbq(i,j,k)=Hz_half(i,j,k)/
< !     &                          (2.*rho_nbq_avg1(i,j,k)
< !     &                          -rho_nbq_avg2(i,j,k))
< 
213,214c199,200
<      &                          (rho_nbq_avg1(i,j,k))
< 
---
>      &                          (1.5*rho_nbq_avg1(i,j,k)
>      &                          -0.5*rho_nbq_avg2(i,j,k))
322a309,310
>           Hzw_half_nbq(i,j,0  )=z_r(i,j,1)-z_w(i,j,0)
>           Hzw_half_nbq(i,j,N  )=z_w(i,j,N)-z_r(i,j,N)
323a312,315
>           Hzw_half_nbq(i,j,1)  =z_r(i,j,2)-z_r(i,j,1)
>           zw_half_nbq(i,j,N)   =zw_half_nbq(i,j,N-1)+Hzr_half_nbq(i,j,N)
>           zr_half_nbq(i,j,N)   =zr_half_nbq(i,j,N-1)
>      &                  +0.5*(Hzr_half_nbq(i,j,N)+Hzr_half_nbq(i,j,N-1))
326c318
<       do k=2,N
---
>       do k=2,N-1
331c323,324
<      &                 +0.5*(Hzr_half_nbq(i,j,k)+Hzr_half_nbq(i,j,k-1))
---
>      &                  +0.5*(Hzr_half_nbq(i,j,k)+Hzr_half_nbq(i,j,k-1))
>             Hzw_half_nbq(i,j,k)=z_r(i,j,k+1)-z_r(i,j,k)
335,378d327
< 	  
<       do k=1,N-1
<         do j=jmin,jmax
<           do i=imin,imax
<             Hzw_half_nbq(i,j,k)=zr_half_nbq(i,j,k+1)-zr_half_nbq(i,j,k)
<           enddo
<         enddo
<       enddo
<       
<       do j=jmin,jmax
<         do i=imin,imax
<           Hzw_half_nbq(i,j,0  )=zr_half_nbq(i,j,1)-zw_half_nbq(i,j,0)
<           Hzw_half_nbq(i,j,N  )=zw_half_nbq(i,j,N)-zr_half_nbq(i,j,N)
<         enddo
<       enddo    
<     
< 
<         ! do k=1,N
<           ! do j=Jstr-1,Jend+1
<           ! do i=Istr,Iend+1
<             ! qdmu_nbq(i,j,k)=u(i,j,k,nstp)*0.5*(Hz(i,j,k)+Hz(i-1,j,k))
<           ! enddo
<           ! enddo
<           ! do j=Jstr,Jend+1
<           ! do i=Istr-1,Iend+1
<             ! qdmv_nbq(i,j,k)=v(i,j,k,nstp)*0.5*(Hz(i,j,k)+Hz(i,j-1,k))
<           ! enddo
<           ! enddo
<         ! enddo
<         
<         ! do k=1,N-1
<           ! do j=Jstr-1,Jend+1
<           ! do i=Istr-1,Iend+1
<             ! qdmw_nbq(i,j,k)=wz(i,j,k,nstp)*0.5*(Hz(i,j,k)+Hz(i,j,k+1))
<           ! enddo
<           ! enddo
<         ! enddo
<         ! k=N
<         ! do j=Jstr-1,Jend+1
<         ! do i=Istr-1,Iend+1
<           ! qdmw_nbq(i,j,k)=wz(i,j,k,nstp)*0.5*(Hz(i,j,k))
<         ! enddo
<         ! enddo
< 	  
542,543c491,492
<       qdm_u_ext(:,:) = 0.
<       qdm_v_ext(:,:) = 0.
---
>       qdm_u_ext(:,:,0) = 0.
>       qdm_v_ext(:,:,0) = 0.
629,630c578,581
<               ruint_nbq(i,j,k)=DC(i,0)*ru(i,j,k)
<               qdm_u_ext(i,j) = qdm_u_ext(i,j) + ruint_nbq(i,j,k)
---
>               qdm_u(i,j,k,1) = 0.
>               qdm_u(i,j,k,2) = u(i,j,k,nstp)*0.5*(Hz(i,j,k)+Hz(i-1,j,k))
>               ruint_nbq(i,j,k) = qdm_u(i,j,k,2)/dt
>               qdm_u_ext(i,j,0) = qdm_u_ext(i,j,0) + ruint_nbq(i,j,k)
642c593
<      &            - qdm_u_ext(i,j) *(Hz(i,j,k)+Hz(i-1,j,k))
---
>      &            - qdm_u_ext(i,j,0) *(Hz(i,j,k)+Hz(i-1,j,k))
661c612
<               qdm_nstp = u(i,j,k,nstp)*0.5*(Hz(i,j,k)+
---
>               u(i,j,k,nnew)=( cff1*u(i,j,k,nstp)*0.5*(Hz(i,j,k)+
663c614
<               qdm_indx = u(i,j,k,indx)*0.5*(Hz_bak(i,j,k)+
---
>      &                       +cff2*u(i,j,k,indx)*0.5*(Hz_bak(i,j,k)+
665,667d615
<              
<               u(i,j,k,nnew)=( cff1*qdm_nstp
<      &                       +cff2*qdm_indx
670,672c618,623
<               ruint_nbq(i,j,k)=DC(i,0)*ru(i,j,k)
<        
<               qdm_u_ext(i,j) =  qdm_u_ext(i,j) + ruint_nbq(i,j,k)
---
>               qdm_u(i,j,k,1) = qdm_u(i,j,k,2)
>               qdm_u(i,j,k,2) = u(i,j,k,nstp)*0.5*(Hz(i,j,k)+
>      &                                            Hz(i-1,j,k))
>               ruint_nbq(i,j,k) = (qdm_u(i,j,k,2)-qdm_u(i,j,k,1))/dt
>      &                           -DC(i,0)*ru_nbq_avg2(i,j,k)
>               qdm_u_ext(i,j,0) =  qdm_u_ext(i,j,0) + ruint_nbq(i,j,k)
693c644
<      &            - qdm_u_ext(i,j) *(Hz(i,j,k)+Hz(i-1,j,k))
---
>      &            - qdm_u_ext(i,j,0) *(Hz(i,j,k)+Hz(i-1,j,k))
731,732c682,687
<               rvint_nbq(i,j,k)=DC(i,0)*rv(i,j,k)
<               qdm_v_ext(i,j) = qdm_v_ext(i,j) + rvint_nbq(i,j,k)
---
>               qdm_v(i,j,k,1) = 0.
>               qdm_v(i,j,k,2) = v(i,j,k,nstp)*0.5*(Hz(i,j,k)
>      &                                           +Hz(i,j-1,k))
>               rvint_nbq(i,j,k) = qdm_v(i,j,k,2)/dt
> 
>               qdm_v_ext(i,j,0) = qdm_v_ext(i,j,0) + rvint_nbq(i,j,k)
743c698
<      &            - qdm_v_ext(i,j) *(Hz(i,j,k)+Hz(i,j-1,k))
---
>      &            - qdm_v_ext(i,j,0) *(Hz(i,j,k)+Hz(i,j-1,k))
763c718
<                 qdm_nstp = v(i,j,k,nstp)*0.5*(Hz(i,j,k)+
---
>                 v(i,j,k,nnew)=( cff1*v(i,j,k,nstp)*0.5*(Hz(i,j,k)+
765c720
<                 qdm_indx = v(i,j,k,indx)*0.5*(Hz_bak(i,j,k)+
---
>      &                         +cff2*v(i,j,k,indx)*0.5*(Hz_bak(i,j,k)+
767,768d721
<                 v(i,j,k,nnew)=( cff1*qdm_nstp
<      &                         +cff2*qdm_indx
771,773c724,729
< 
<               rvint_nbq(i,j,k)=DC(i,0)*rv(i,j,k)
<               qdm_v_ext(i,j) =  qdm_v_ext(i,j) + rvint_nbq(i,j,k)
---
>               qdm_v(i,j,k,1) = qdm_v(i,j,k,2)
>               qdm_v(i,j,k,2) = v(i,j,k,nstp)*0.5*(Hz(i,j,k)+
>      &                                            Hz(i,j-1,k))
>               rvint_nbq(i,j,k) = (qdm_v(i,j,k,2)-qdm_v(i,j,k,1))/dt
>      &                           -DC(i,0)*rv_nbq_avg2(i,j,k)
>               qdm_v_ext(i,j,0) =  qdm_v_ext(i,j,0) + rvint_nbq(i,j,k)
792c748
<      &            - qdm_v_ext(i,j) *(Hz(i,j,k)+Hz(i,j-1,k))
---
>      &            - qdm_v_ext(i,j,0) *(Hz(i,j,k)+Hz(i,j-1,k))
836c792,795
<             rwint_nbq(i,j,k)=pn(i,j)*pm(i,j)*rw(i,j,k)
---
>             qdm_w(i,j,k,1)=0.
>             qdm_w(i,j,k,2)=wz(i,j,k,nstp)*(Hz(i,j,k)+Hz(i,j,k+1))/2.
>             rwint_nbq(i,j,k)= qdm_w(i,j,k,2)/dt
>      &                      - pn(i,j)*pm(i,j)*rw_nbq_avg2(i,j,k)
853c812,816
<             rwint_nbq(i,j,N)=pn(i,j)*pm(i,j)*rw(i,j,N)
---
>             qdm_w(i,j,N,1)=0.
>             qdm_w(i,j,N,2)=wz(i,j,N,nstp)*Hz(i,j,N)/2.
>             rwint_nbq(i,j,N)=(qdm_w(i,j,N,2)-qdm_w(i,j,N,1))/dt
>      &                      - pn(i,j)*pm(i,j)*rw_nbq_avg2(i,j,N)
> 
867d829
< #ifndef NBQ
876,887c838,843
< #else
<              qdm_nstp = wz(i,j,k,nstp)*(Hz(i,j,k  )+         ! n      
<      &                                             Hz(i,j,k+1))
<              qdm_indx = wz(i,j,k,indx)*(Hz_bak(i,j,k  )+     ! n - 1
<      &                                             Hz_bak(i,j,k+1))
<              wz(i,j,k,nnew)=( cff1*qdm_nstp         !
<      &                       +cff2*qdm_indx         !
<      &                       +2.*cdt*pn(i,j)*pm(i,j)                    ! n - 1/2
<      &                              *(rw(i,j,k)+rw_nbq_avg1(i,j,k))     !
<      &                      ) / (Hz_half(i,j,k)+Hz_half(i,j,k+1))  !<-- wz has units m.s-1
<       
<              rwint_nbq(i,j,k)=pn(i,j)*pm(i,j)*rw(i,j,k)
---
> #ifdef NBQ
>              qdm_w(i,j,k,1)=qdm_w(i,j,k,2)
>              qdm_w(i,j,k,2)=wz(i,j,k,nstp)*(Hz(i,j,k  )+
>      &                                      Hz(i,j,k+1))/2.
>              rwint_nbq(i,j,k)=(qdm_w(i,j,k,2)-qdm_w(i,j,k,1))/dt
>      &                      - pn(i,j)*pm(i,j)*rw_nbq_avg2(i,j,k)
894c850
<        enddo
---
>        enddo              
898d853
< #ifndef NBQ
905,914c860,864
< #else
<              qdm_nstp = wz(i,j,N,nstp)*Hz    (i,j,N)
<              qdm_indx = wz(i,j,N,indx)*Hz_bak(i,j,N)
<              wz(i,j,N,nnew)=( cff1*qdm_nstp
<      &                       +cff2*qdm_indx
<      &                       +2.*cdt*pn(i,j)*pm(i,j)
<      &                          *(rw(i,j,N)+rw_nbq_avg1(i,j,N))
<      &                      )/ Hz_half(i,j,N)                !<-- wz has units m.s-1
<      
<              rwint_nbq(i,j,N)=pn(i,j)*pm(i,j)*rw(i,j,N)
---
> #ifdef NBQ
>              qdm_w(i,j,N,1)=qdm_w(i,j,N,2)
>              qdm_w(i,j,N,2)=wz(i,j,N,nstp)*Hz(i,j,N)/2.
>              rwint_nbq(i,j,N)=(qdm_w(i,j,N,2)-qdm_w(i,j,N,1))/dt
>      &                      -  pn(i,j)*pm(i,j)*rw_nbq_avg2(i,j,N)
prsgrd.F
prsgrd31.F
put_global_atts.F
random_walk.F
read_inp.F
108c108
<       fname='TEST_CASES/croco.in.Tank_nbq'
---
>       fname='./TEST_CASES/croco.in.Tank_nbq'
rho_eos.F
476,477c476,477
<         do j=Jstr,Jend
<           do i=Istr,Iend
---
>         do j=JstrR,JendR
>           do i=IstrR,IendR
513d512
<       
551d549
<         rho0 = nint(rho0*1.d12,kind=8)/1.d12
rhs3d.F
rhs3d_w_nh.F
2d1
< #undef UV_VADV_SPLINES
rhs_floats.F
rnbq_bc.F
15c15
< # if defined NBQ && !defined NBQ_IJK
---
> # ifdef NBQ
35c35
< ! rhp_nbq_a(W_index) for the parent grid.
---
> ! rhp_nbq_a(W_index,2) for the parent grid.
39c39
< # if defined NBQ && !defined NBQ_IJK
---
> # ifdef NBQ
46c46
< ! rhp_nbq_a(W_index) for the child grid.
---
> ! rhp_nbq_a(W_index,2) for the child grid.
50c50
< # if defined NBQ && !defined NBQ_IJK
---
> #ifdef NBQ
109,110c109,110
<             grad(Istr-1,j)=(rhp_nbq_a(l_b_j  )
<      &                     -rhp_nbq_a(l_b_jm1))
---
>             grad(Istr-1,j)=(rhp_nbq_a(l_b_j  ,nstp)
>      &                     -rhp_nbq_a(l_b_jm1,nstp))
114,115c114,115
<             grad(Istr  ,j)=(rhp_nbq_a(l_bm1_j  )
<      &                     -rhp_nbq_a(l_bm1_jm1))
---
>             grad(Istr  ,j)=(rhp_nbq_a(l_bm1_j  ,nstp)
>      &                     -rhp_nbq_a(l_bm1_jm1,nstp))
126,127c126,127
<             dft=rhp_nbq_a(l_bm1_j)-rhp_nbq_a(l_bm1_j)
<             dfx=rhp_nbq_a(l_bm1_j)-rhp_nbq_a(l_bm2_j)
---
>             dft=rhp_nbq_a(l_bm1_j,nstp)-rhp_nbq_a(l_bm1_j,nnew)
>             dfx=rhp_nbq_a(l_bm1_j,nnew)-rhp_nbq_a(l_bm2_j,nnew)
155,156c155,156
<             rhp_nbq_a(l_b_j)=( cff*rhp_nbq_a(l_b_j  )
<      &                              +cx*rhp_nbq_a(l_bm1_j)
---
>             rhp_nbq_a(l_b_j,nnew)=( cff*rhp_nbq_a(l_b_j  ,nstp)
>      &                              +cx*rhp_nbq_a(l_bm1_j,nnew)
161c161
<             rhp_nbq_a(l_b_j)=(1.-tau)*rhp_nbq_a(l_b_j)
---
>             rhp_nbq_a(l_b_j,nnew)=(1.-tau)*rhp_nbq_a(l_b_j,nnew)
169c169
<             rhp_nbq_a(l_b_j)=rhp_nbq_a(l_b_j)*rmask(Istr-1,j)
---
>             rhp_nbq_a(l_b_j,nnew)=rhp_nbq_a(l_b_j,nnew)*rmask(Istr-1,j)
181c181
<             rhp_nbq_a(l_b_j)=rnbqbry_west(j,k)         ! specified
---
>             rhp_nbq_a(l_b_j,nnew)=rnbqbry_west(j,k)         ! specified
183c183
<             rhp_nbq_a(l_b_j)=rnbqclm(Istr-1,j,k)
---
>             rhp_nbq_a(l_b_j,nnew)=rnbqclm(Istr-1,j,k)
197c197
< !            rhp_nbq_a(l_b_j)=rhp_nbq_a(l_bm1_j) ! Gradient: default
---
> !            rhp_nbq_a(l_b_j,nnew)=rhp_nbq_a(l_bm1_j,nnew) ! Gradient: default
219,220c219,220
<             grad(Iend  ,j)=(rhp_nbq_a(l_bm1_j  )
<      &                     -rhp_nbq_a(l_bm1_jm1))
---
>             grad(Iend  ,j)=(rhp_nbq_a(l_bm1_j  ,nstp)
>      &                     -rhp_nbq_a(l_bm1_jm1,nstp))
224,225c224,225
<             grad(Iend+1,j)=(rhp_nbq_a(l_b_j  )
<      &                     -rhp_nbq_a(l_b_jm1))
---
>             grad(Iend+1,j)=(rhp_nbq_a(l_b_j  ,nstp)
>      &                     -rhp_nbq_a(l_b_jm1,nstp))
236,237c236,237
<             dft=rhp_nbq_a(l_bm1_j)-rhp_nbq_a(l_bm1_j)
<             dfx=rhp_nbq_a(l_bm1_j)-rhp_nbq_a(l_bm2_j)
---
>             dft=rhp_nbq_a(l_bm1_j,nstp)-rhp_nbq_a(l_bm1_j,nnew)
>             dfx=rhp_nbq_a(l_bm1_j,nnew)-rhp_nbq_a(l_bm2_j,nnew)
265,266c265,266
<             rhp_nbq_a(l_b_j)=( cff*rhp_nbq_a(l_b_j  )
<      &                              +cx*rhp_nbq_a(l_bm1_j)
---
>             rhp_nbq_a(l_b_j,nnew)=( cff*rhp_nbq_a(l_b_j  ,nstp)
>      &                              +cx*rhp_nbq_a(l_bm1_j,nnew)
271c271
<             rhp_nbq_a(l_b_j)=(1.-tau)*rhp_nbq_a(l_b_j)
---
>             rhp_nbq_a(l_b_j,nnew)=(1.-tau)*rhp_nbq_a(l_b_j,nnew)
279c279
<             rhp_nbq_a(l_b_j)=rhp_nbq_a(l_b_j)*rmask(Iend+1,j)
---
>             rhp_nbq_a(l_b_j,nnew)=rhp_nbq_a(l_b_j,nnew)*rmask(Iend+1,j)
291c291
<              rhp_nbq_a(l_b_j)=rnbqbry_east(j,k)       ! specified
---
>              rhp_nbq_a(l_b_j,nnew)=rnbqbry_east(j,k)       ! specified
293c293
<              rhp_nbq_a(l_b_j)=rnbqclm(Iend+1,j,k)
---
>              rhp_nbq_a(l_b_j,nnew)=rnbqclm(Iend+1,j,k)
307c307
< !            rhp_nbq_a(l_b_j)=rhp_nbq_a(l_bm1_j)  ! gradient (default)
---
> !            rhp_nbq_a(l_b_j,nnew)=rhp_nbq_a(l_bm1_j,nnew)  ! gradient (default)
332,333c332,333
<             grad(i,Jstr-1)=(rhp_nbq_a(l_b_i  )
<      &                     -rhp_nbq_a(l_b_im1))
---
>             grad(i,Jstr-1)=(rhp_nbq_a(l_b_i  ,nstp)
>      &                     -rhp_nbq_a(l_b_im1,nstp))
337,338c337,338
<             grad(i,Jstr  )=(rhp_nbq_a(l_bm1_i  )
<      &                     -rhp_nbq_a(l_bm1_im1))
---
>             grad(i,Jstr  )=(rhp_nbq_a(l_bm1_i  ,nstp)
>      &                     -rhp_nbq_a(l_bm1_im1,nstp))
349,350c349,350
<             dft=rhp_nbq_a(l_bm1_i)-rhp_nbq_a(l_bm1_i)
<             dfx=rhp_nbq_a(l_bm1_i)-rhp_nbq_a(l_bm2_i)
---
>             dft=rhp_nbq_a(l_bm1_i,nstp)-rhp_nbq_a(l_bm1_i,nnew)
>             dfx=rhp_nbq_a(l_bm1_i,nnew)-rhp_nbq_a(l_bm2_i,nnew)
378,379c378,379
<             rhp_nbq_a(l_b_i)=( cff*rhp_nbq_a(l_b_i  )
<      &                              +cx*rhp_nbq_a(l_bm1_i)
---
>             rhp_nbq_a(l_b_i,nnew)=( cff*rhp_nbq_a(l_b_i  ,nstp)
>      &                              +cx*rhp_nbq_a(l_bm1_i,nnew)
384c384
<             rhp_nbq_a(l_b_i)=(1.-tau)*rhp_nbq_a(l_b_i)
---
>             rhp_nbq_a(l_b_i,nnew)=(1.-tau)*rhp_nbq_a(l_b_i,nnew)
392c392
<             rhp_nbq_a(l_b_i)=rhp_nbq_a(l_b_i)*rmask(i,Jstr-1)
---
>             rhp_nbq_a(l_b_i,nnew)=rhp_nbq_a(l_b_i,nnew)*rmask(i,Jstr-1)
403c403
<             rhp_nbq_a(l_b_i)=rnbqbry_south(i,k)        ! specified
---
>             rhp_nbq_a(l_b_i,nnew)=rnbqbry_south(i,k)        ! specified
405c405
<             rhp_nbq_a(l_b_i)=rnbqclm(i,Jstr-1,k)
---
>             rhp_nbq_a(l_b_i,nnew)=rnbqclm(i,Jstr-1,k)
419c419
< !            rhp_nbq_a(l_b_i)=rhp_nbq_a(l_bm1_i)  ! gradient (default)
---
> !            rhp_nbq_a(l_b_i,nnew)=rhp_nbq_a(l_bm1_i,nnew)  ! gradient (default)
441,442c441,442
<             grad(i,Jend  )=(rhp_nbq_a(l_bm1_j  )
<      &                     -rhp_nbq_a(l_bm1_im1))
---
>             grad(i,Jend  )=(rhp_nbq_a(l_bm1_j  ,nstp)
>      &                     -rhp_nbq_a(l_bm1_im1,nstp))
446,447c446,447
<             grad(i,Jend+1)=(rhp_nbq_a(l_b_j  )
<      &                     -rhp_nbq_a(l_b_im1))
---
>             grad(i,Jend+1)=(rhp_nbq_a(l_b_j  ,nstp)
>      &                     -rhp_nbq_a(l_b_im1,nstp))
458,459c458,459
<             dft=rhp_nbq_a(l_bm1_i)-rhp_nbq_a(l_bm1_i)
<             dfx=rhp_nbq_a(l_bm1_i)-rhp_nbq_a(l_bm2_i)
---
>             dft=rhp_nbq_a(l_bm1_i,nstp)-rhp_nbq_a(l_bm1_i,nnew)
>             dfx=rhp_nbq_a(l_bm1_i,nnew)-rhp_nbq_a(l_bm2_i,nnew)
487,488c487,488
<             rhp_nbq_a(l_b_i)=( cff*rhp_nbq_a(l_b_i)
<      &                              +cx*rhp_nbq_a(l_bm1_i)
---
>             rhp_nbq_a(l_b_i,nnew)=( cff*rhp_nbq_a(l_b_i  ,nstp)
>      &                              +cx*rhp_nbq_a(l_bm1_i,nnew)
493c493
<             rhp_nbq_a(l_b_i)=(1.-tau)*rhp_nbq_a(l_b_i)
---
>             rhp_nbq_a(l_b_i,nnew)=(1.-tau)*rhp_nbq_a(l_b_i,nnew)
501c501
<             rhp_nbq_a(l_b_i)=rhp_nbq_a(l_b_i)*rmask(i,Jend+1)
---
>             rhp_nbq_a(l_b_i,nnew)=rhp_nbq_a(l_b_i,nnew)*rmask(i,Jend+1)
513c513
<             rhp_nbq_a(l_b_i)=rnbqbry_north(i,k)      ! specified
---
>             rhp_nbq_a(l_b_i,nnew)=rnbqbry_north(i,k)      ! specified
515c515
<             rhp_nbq_a(l_b_i)=rnbqclm(i,Jend+1,k)
---
>             rhp_nbq_a(l_b_i,nnew)=rnbqclm(i,Jend+1,k)
529c529
< !            rhp_nbq_a(l_b_i)=rhp_nbq_a(l_bm1_i) ! gradient (default)
---
> !            rhp_nbq_a(l_b_i,nnew)=rhp_nbq_a(l_bm1_i,nnew) ! gradient (default)
548,549c548,549
<           rhp_nbq_a(l_c)=0.5*(rhp_nbq_a(l_c_im1)
<      &                            +rhp_nbq_a(l_c_jm1))
---
>           rhp_nbq_a(l_c,nnew)=0.5*(rhp_nbq_a(l_c_im1,nnew)
>      &                            +rhp_nbq_a(l_c_jm1,nnew))
562,563c562,563
<           rhp_nbq_a(l_c)=0.5*(rhp_nbq_a(l_c_im1)
<      &                            +rhp_nbq_a(l_c_jm1))
---
>           rhp_nbq_a(l_c,nnew)=0.5*(rhp_nbq_a(l_c_im1,nnew)
>      &                            +rhp_nbq_a(l_c_jm1,nnew))
576,577c576,577
<           rhp_nbq_a(l_c)=0.5*(rhp_nbq_a(l_c_im1)
<      &                            +rhp_nbq_a(l_c_jm1))
---
>           rhp_nbq_a(l_c,nnew)=0.5*(rhp_nbq_a(l_c_im1,nnew)
>      &                            +rhp_nbq_a(l_c_jm1,nnew))
590,591c590,591
<           rhp_nbq_a(l_c)=0.5*(rhp_nbq_a(l_c_im1)
<      &                            +rhp_nbq_a(l_c_jm1))
---
>           rhp_nbq_a(l_c,nnew)=0.5*(rhp_nbq_a(l_c_im1,nnew)
>      &                            +rhp_nbq_a(l_c_jm1,nnew))
rnbqijk_bc.F
sediment.F
set_avg.F
set_bio_diags_avg.F
set_cycle.F
set_depth.F
15,19c15
<       subroutine set_depth (tile
< #ifdef NBQ
<      &   ,resetfromrhobar
< #endif
<      &   )
---
>       subroutine set_depth (tile)
23,25d18
< #ifdef NBQ
<       integer resetfromrhobar
< #endif  
28,32c21
<       call set_depth_tile (Istr,Iend,Jstr,Jend
< #ifdef NBQ
<      &   ,resetfromrhobar
< #endif
<      &   )
---
>       call set_depth_tile (Istr,Iend,Jstr,Jend)
36,40c25
<       subroutine set_depth_tile (Istr,Iend,Jstr,Jend
< #ifdef NBQ
<      &   ,resetfromrhobar
< #endif
<      &   )
---
>       subroutine set_depth_tile (Istr,Iend,Jstr,Jend)
52,54d36
< #ifdef NBQ
<       integer resetfromrhobar
< #endif      
115d96
<           
123,124c104,106
<             elseif (resetfromrhobar == 1) then ! Here zeta is zeta + h
<               Zt_avg1(i,j) = zeta(i,j,1)*rhobar_nbq(i,j,1)
---
>             else
>              if (zeta(i,j,1).eq.h(i,j).and.rhobar_nbq(i,j,1).ne.1.) then
>               Zt_avg1(i,j) = rhobar_nbq(i,j,1)*h(i,j)
128a111
>              endif
130,131c113
< 
< #  endif 
---
> #  endif
set_diagsM_avg.F
set_diags_avg.F
set_nudgcof.F
set_nudgcof_fine.F
set_scoord.F
set_weights.F
setup_grid1.F
setup_grid2.F
srcscheck.F
sstskin.F
step.F
step2d.F
35,45d34
< #if defined NBQ
< #if defined NBQ_IJK
<      &                    , A3d(1,1,trd), A3d(1,2,trd)
<      &                    , A3d(1,3,trd), A3d(1,4,trd)
<      &                    , A2d(1,14,trd)                     ! A2d(:,14-25,trd) used as working arrays for NBQ
<      &                    , A3d(1,6,trd)                      ! A3d(:,6-,trd) used as working arrays for NBQ
< #endif
<      &                    , A2d(1,26,trd), A2d(1,27,trd)
<      &                    , A2d(1,28,trd), A2d(1,29,trd)
<      &                    , A2d(1,30,trd), A2d(1,31,trd)
< #endif
61,71d49
< #if defined NBQ
< #if defined NBQ_IJK
<      &                          ,Hzw_half_nbq_inv, Hzr_half_nbq_inv 
<      &                          ,Hzw_half_nbq_inv_u,Hzw_half_nbq_inv_v
<      &                          ,work_nbq
<      &                          ,work3d_nbq
< #endif
<      &                          ,ruext_nbq_2d_sum, rvext_nbq_2d_sum
<      &                          ,ruext_nbq_2d_old, rvext_nbq_2d_old
<      &                          ,Drhs_half_u,Drhs_half_v
< #endif
158,175d135
< #if defined NBQ
< #if defined NBQ_IJK
<        real Hzw_half_nbq_inv(PRIVATE_2D_SCRATCH_ARRAY,0:N)
<        real Hzr_half_nbq_inv(PRIVATE_2D_SCRATCH_ARRAY,N)
< 	   real Hzw_half_nbq_inv_u(PRIVATE_2D_SCRATCH_ARRAY,0:N)
< 	   real Hzw_half_nbq_inv_v(PRIVATE_2D_SCRATCH_ARRAY,0:N)
<        real work_nbq(PRIVATE_2D_SCRATCH_ARRAY,11)
<        real work3d_nbq(PRIVATE_2D_SCRATCH_ARRAY,N,5)
< 
< 
< #endif
<        real ruext_nbq_2d_sum(PRIVATE_2D_SCRATCH_ARRAY)
<        real rvext_nbq_2d_sum(PRIVATE_2D_SCRATCH_ARRAY)
<        real ruext_nbq_2d_old(PRIVATE_2D_SCRATCH_ARRAY)
<        real rvext_nbq_2d_old(PRIVATE_2D_SCRATCH_ARRAY)
<        real Drhs_half_u(PRIVATE_2D_SCRATCH_ARRAY)
<        real Drhs_half_v(PRIVATE_2D_SCRATCH_ARRAY)
< #endif
425a386,388
> #ifdef NBQ
>           l_nh=ijk2lq_nh(i,j,N)
> #endif
428a392
> 
477,478c441
<          zwrk(i,j)=cff0*zeta_new(i,j)
<      &  /(2.*rhobar_nbq(i,j,kstp)-rhobar_nbq(i,j,kbak))
---
>           zwrk(i,j)=cff0*zeta_new(i,j) /rhobar_nbq(i,j,knew)
483d445
<      
500c462
<      &             +cff2*zeta(i,j,kbak)+cff3*zeta(i,j,kold)   
---
>      &             +cff2*zeta(i,j,kbak)+cff3*zeta(i,j,kold)
674c636
<      &                                                              )    
---
>      &                                                              )
676,677d637
<       
<       
1287,1322c1247,1277
<         if (FIRST_TIME_STEP) then 
<           cff2=0.                        ! 
<           cff1=1.                        !
<         else                             !
<           cff2=-0.5
<           cff1=1.5
<         endif
<         
<  !       do k=1,N
<  !         do j=Jstr,Jend
<  !           do i=IstrU,Iend
<  !             cff=ruint_nbq(i,j,k)
<  !             ruint_nbq(i,j,k)=cff1*cff 
<  !    &                       + cff2*ruint_bak_nbq(i,j,k)
<  !             ruint_bak_nbq(i,j,k)=cff
<  !           enddo
<  !         enddo
<  !         do j=JstrV,Jend
<  !           do i=Istr,Iend
<  !             cff=rvint_nbq(i,j,k)
<  !             rvint_nbq(i,j,k)=cff1*cff
<  !    &                       + cff2*rvint_bak_nbq(i,j,k)
<  !             rvint_bak_nbq(i,j,k)=cff
<  !           enddo
<  !         enddo
<  !       enddo
<  !       do k=0,N
<  !         do j=Jstr,Jend
<  !           do i=Istr,Iend
<  !             cff=rwint_nbq(i,j,k)
<  !             rwint_nbq(i,j,k)=cff1*cff
<  !    &                       + cff2*rwint_bak_nbq(i,j,k)
<  !             rwint_bak_nbq(i,j,k)=cff
<  !           enddo
<  !         enddo
<  !       enddo
---
>         do k=1,N
>           do j=Jstr,Jend
>             do i=IstrU,Iend
>               cff=ruint_nbq(i,j,k)
>               ruint_nbq(i,j,k)=cff1*cff 
>      &                       + cff2*ruint_bak_nbq(i,j,k,3-nstp)
>      &                       + cff3*ruint_bak_nbq(i,j,k,nstp)
>               ruint_bak_nbq(i,j,k,nstp)=cff
>             enddo
>           enddo
>           do j=JstrV,Jend
>             do i=Istr,Iend
>               cff=rvint_nbq(i,j,k)
>               rvint_nbq(i,j,k)=cff1*cff
>      &                       + cff2*rvint_bak_nbq(i,j,k,3-nstp)
>      &                       + cff3*rvint_bak_nbq(i,j,k,nstp)
>               rvint_bak_nbq(i,j,k,nstp)=cff
>             enddo
>           enddo
>         enddo
>         do k=0,N
>           do j=Jstr,Jend
>             do i=Istr,Iend
>               cff=rwint_nbq(i,j,k)
>               rwint_nbq(i,j,k)=cff1*cff
>      &                       + cff2*rwint_bak_nbq(i,j,k,3-nstp)
>      &                       + cff3*rwint_bak_nbq(i,j,k,nstp)
>               rwint_bak_nbq(i,j,k,nstp)=cff
>             enddo
>           enddo
>         enddo
1415,1425d1369
< 
< #if defined M2FILTER_NONE
<       if (FIRST_2D_STEP) then
<       do j=Jstr,Jend
<         do i=IstrU,Iend
<           ruext_nbq_2d_sum(i,j)=0.
<           ruext_nbq_2d_old(i,j)=0.
<           Drhs_half_u(i,j) = 0.
<         enddo
<       enddo
< 
1429,1433c1373,1375
<             Drhs_half_u(i,j)=Drhs_half_u(i,j)
<      & *(Hz_half(i-1,j,k)+Hz_half(i,j,k))
< #ifdef MASKING
<             ruint_nbq(i,j,k)=ruint_nbq(i,j,k)*umask(i,j)
< #endif
---
>             ruext_nbq(i,j,k)=(rufrc(i,j)+rubar(i,j))*pm_u(i,j)*pn_u(i,j)
>      &                                *(Hz_half(i,j,k)+Hz_half(i-1,j,k))
>      &                                          /(Drhs(i,j)+Drhs(i-1,j))
1436,1446d1377
<       enddo
<  
<       do j=JstrV,Jend
<         do i=Istr,Iend
<           rvext_nbq_2d_sum(i,j)=0.
<           rvext_nbq_2d_old(i,j)=0.
<           Drhs_half_v(i,j) = 0.
<         enddo
<       enddo 
< 
<       do k=1,N
1449,1453c1380,1382
<             Drhs_half_v(i,j)=Drhs_half_v(i,j)
<      & *(Hz_half(i,j-1,k)+Hz_half(i,j,k))
< #ifdef MASKING
<             rvint_nbq(i,j,k)=rvint_nbq(i,j,k)*vmask(i,j)
< #endif
---
>             rvext_nbq(i,j,k)=(rvfrc(i,j)+rvbar(i,j))*pm_v(i,j)*pn_v(i,j)
>      &                                *(Hz_half(i,j,k)+Hz_half(i,j-1,k))
>      &                                          /(Drhs(i,j)+Drhs(i,j-1))
1457,1541d1385
<      
<       endif
< #endif
< 
< # define ruext_nbq_2d UFx
<       do j=Jstr,Jend
<         do i=IstrU,Iend
<           ruext_nbq_2d(i,j)=(rufrc(i,j)+rubar(i,j))*pm_u(i,j)*pn_u(i,j)
<      &              /(Drhs(i,j)+Drhs(i-1,j))
< #ifdef MASKING
<           ruext_nbq_2d(i,j)=ruext_nbq_2d(i,j)*umask(i,j)
< #endif
< #if defined M2FILTER_NONE     
<           ruext_nbq_2d_sum(i,j)=ruext_nbq_2d_sum(i,j)+ruext_nbq_2d(i,j)
< #endif          
<         enddo
<       enddo
< 
< 
<        do j=Jstr,Jend
<          do i=IstrU,Iend
<             rubarint_nbq(i,j)=rubarint_nbq(i,j)+
<      &  (ruext_nbq_2d(i,j)-ruext_nbq_2d_old(i,j))
<      & *Drhs_half_u(i,j)
<          enddo
<        enddo
<        
<       do k=1,N
<         do j=Jstr,Jend
<           do i=IstrU,Iend
<             ruint_nbq(i,j,k)=ruint_nbq(i,j,k)+
<      &  (ruext_nbq_2d(i,j)-ruext_nbq_2d_old(i,j))
<      & *(Hz_half(i-1,j,k)+Hz_half(i,j,k))
<           enddo
<         enddo
<       enddo      
< 
<       do j=Jstr,Jend
<         do i=IstrU,Iend
<           ruext_nbq_2d_old(i,j)=ruext_nbq_2d(i,j)
<         enddo
<       enddo
<       
< #undef ruext_nbq_2d
< 
< # define rvext_nbq_2d UFx
<       do j=JstrV,Jend
<         do i=Istr,Iend
<           rvext_nbq_2d(i,j)=(rvfrc(i,j)+rvbar(i,j))*pm_v(i,j)*pn_v(i,j)
<      &              /(Drhs(i,j)+Drhs(i,j-1))
< #ifdef MASKING
<           rvext_nbq_2d(i,j)=rvext_nbq_2d(i,j)*vmask(i,j)
< #endif
< #if defined M2FILTER_NONE     
<           rvext_nbq_2d_sum(i,j)=rvext_nbq_2d_sum(i,j)+rvext_nbq_2d(i,j)
< #endif          
<         enddo
<       enddo
< 
<       do j=JstrV,Jend
<         do i=Istr,Iend
<             rvbarint_nbq(i,j)=rvbarint_nbq(i,j)+
<      &  (rvext_nbq_2d(i,j)-rvext_nbq_2d_old(i,j))
<      & *Drhs_half_v(i,j)
<         enddo
<       enddo
<         
<       do k=1,N
<         do j=JstrV,Jend
<           do i=Istr,Iend
<             rvint_nbq(i,j,k)=rvint_nbq(i,j,k)+
<      &  (rvext_nbq_2d(i,j)-rvext_nbq_2d_old(i,j))
<      & *(Hz_half(i,j-1,k)+Hz_half(i,j,k))
<           enddo
<         enddo
<       enddo
< 
<       do j=JstrV,Jend
<         do i=Istr,Iend
<           rvext_nbq_2d_old(i,j)=rvext_nbq_2d(i,j)
<         enddo
<       enddo
< #undef rvext_nbq_2d      
<       
< 
1559,1568c1403
<         call grid_coef_nh(
< #if defined NBQ_IJK
<      &   Istr,Iend,Jstr,Jend,
<      &   Hzw_half_nbq_inv,Hzr_half_nbq_inv,
<      &   Hzw_half_nbq_inv_u, Hzw_half_nbq_inv_v,
<      &   work3d_nbq(START_2D_ARRAY,1,1),
<      &   work3d_nbq(START_2D_ARRAY,1,2)
< #endif
<      &   )
< # ifndef NBQ_IJK
---
>         call grid_coef_nh
1571,1634d1405
< # endif
< 
<            do j=jstrq_nh-1,jendq_nh+1
<              do i=istrq_nh-1,iendq_nh+1
<                rhobar_nbq_int(i,j)= 0.
< 			 enddo
< 		  enddo
< 		  
<          do k=1,N
<            do j=jstrq_nh-1,jendq_nh+1
<              do i=istrq_nh-1,iendq_nh+1
<                rhobar_nbq_int(i,j)= rhobar_nbq_int(i,j)
<      &              +(1./rho0)*rho(i,j,k)*Hzr_half_nbq(i,j,k)
<              enddo  
<            enddo  
<          enddo
<          
< #if defined M2FILTER_NONE
<      !     do k=1,N
<      !       do j=Jstr,Jend
<      !         do i=Istr,Iend
<      !           rho_nbq_avg2(i,j,k)=0.
<      !         enddo
<      !       enddo 
<      !     enddo
<      
<           do k=1,N
<             do j=Jstr,Jend
<               do i=IstrU,Iend
< #if defined NBQ_IJK
<                 ru_nbq_avg2(i,j,k)=qdmu_nbq(i,j,k)
< #else
<                 l_nbq=ijk2lmom_nh(i,j,k,1)
<                 ru_nbq_avg2(i,j,k)=qdm_nbq_a(l_nbq)
< #endif
<               enddo
<             enddo 
<           enddo
<           do k=1,N
<             do j=JstrV,Jend
<               do i=Istr,Iend
< #if defined NBQ_IJK
<                 rv_nbq_avg2(i,j,k)=qdmv_nbq(i,j,k)
< #else
<                 l_nbq=ijk2lmom_nh(i,j,k,2)
<                 rv_nbq_avg2(i,j,k)=qdm_nbq_a(l_nbq)
< #endif
<               enddo
<             enddo 
<           enddo
<           do k=0,N
<             do j=Jstr,Jend
<               do i=Istr,Iend
< #if defined NBQ_IJK
<                 rw_nbq_avg2(i,j,k)=qdmw_nbq(i,j,k)
< #else
<                 l_nbq=ijk2lmom_nh(i,j,k,3)
<                 rw_nbq_avg2(i,j,k)=qdm_nbq_a(l_nbq)
< #endif
<               enddo
<             enddo 
<           enddo
< #endif
<         
1640c1411
< # elif defined NBQ_FB && !defined NBQ_IJK
---
> # elif defined NBQ_FB
1642,1652d1412
< # elif defined NBQ_FB && defined NBQ_IJK
<       call step3d_fbijk_nbq (Istr,Iend,Jstr,Jend, WORK
<      &     ,Hzw_half_nbq_inv,Hzr_half_nbq_inv
<      &     ,Hzw_half_nbq_inv_u,Hzw_half_nbq_inv_v
<      &     ,work_nbq(START_2D_ARRAY,1), work_nbq(START_2D_ARRAY,3)
<      &     ,work_nbq(START_2D_ARRAY,5), work_nbq(START_2D_ARRAY,7)
<      &     ,work_nbq(START_2D_ARRAY,9), work_nbq(START_2D_ARRAY,10)
<      &     ,work_nbq(START_2D_ARRAY,11)
<      &     ,work3d_nbq(START_2D_ARRAY,1,1)
<      &     ,work3d_nbq(START_2D_ARRAY,1,2)
<      &     )
1663c1423
<      
---
> 
1668,1669d1427
< 
< #if !defined M2FILTER_NONE
1758,1851d1515
< #else
<         
<      !     do k=1,N
<      !       do j=Jstr,Jend
<      !         do i=Istr,Iend
<      !           rho_nbq_avg2(i,j,k)=rho_nbq_avg2(i,j,k)
<      !&                              +rho_nbq(i,j,k)
<      !         enddo
<      !       enddo 
<      !     enddo          
<           
<         if (LAST_2D_STEP) then
<           do j=Jstr,Jend
<             do i=Istr,Iend
<               rhobar_nbq_avg1(i,j)=rhobar_nbq(i,j,knew)
<             enddo
<           enddo 
<           do k=1,N
<             do j=Jstr,Jend
<               do i=Istr,Iend
<                 rho_nbq_avg1(i,j,k)=1.d0+
<      &               (rho_nbq(i,j,k)+rho(i,j,k)/rho0  )
<      !           rho_nbq_avg2(i,j,k)=rho_nbq_avg2(i,j,k)/real(nfast)
<      !           rho_nbq_avg2(i,j,k)=1.d0+
<      !&               (rho_nbq_avg2(i,j,k)+rho(i,j,k)/rho0  )
<               enddo
<             enddo 
<           enddo
<           do k=1,N
<             do j=Jstr,Jend
<               do i=IstrU,Iend
<          !       ru_nbq_avg1(i,j,k)=ru_nbq_ext(i,j,k)
< 
<              ruint_nbq(i,j,k) = ruint_nbq(i,j,k)
<      &   -ruext_nbq_2d_old(i,j)*(Hz_half(i-1,j,k)+Hz_half(i,j,k))
< #if defined NBQ_IJK
<          ru_nbq_avg2(i,j,k)=
<      &   ((qdmu_nbq(i,j,k)-ru_nbq_avg2(i,j,k))/
<      &   (dt)-ruint_nbq(i,j,k)-(ruext_nbq_2d_sum(i,j)/nfast)*
<      &     (Hz_half(i,j,k)+Hz_half(i-1,j,k)))*on_u(i,j)*om_u(i,j)
< #else
<          l_nbq=ijk2lmom_nh(i,j,k,1)
<          ru_nbq_avg2(i,j,k)=
<      &   ((qdm_nbq_a(l_nbq)-ru_nbq_avg2(i,j,k))/
<      &   (dt)-ruint_nbq(i,j,k)-(ruext_nbq_2d_sum(i,j)/nfast)*
<      &     (Hz_half(i,j,k)+Hz_half(i-1,j,k)))*on_u(i,j)*om_u(i,j)
< #endif
< 
< 
<               enddo
<             enddo 
<           enddo
<           do k=1,N
<             do j=JstrV,Jend
<               do i=Istr,Iend             
<           !       rv_nbq_avg1(i,j,k)=rv_nbq_ext(i,j,k) 
< 
<              rvint_nbq(i,j,k) = rvint_nbq(i,j,k)
<      &   -rvext_nbq_2d_old(i,j)*(Hz_half(i,j-1,k)+Hz_half(i,j,k))
< 
< #if defined NBQ_IJK
<                  rv_nbq_avg2(i,j,k)=
<      &   ((qdmv_nbq(i,j,k)-rv_nbq_avg2(i,j,k))/
<      &   (dt)-rvint_nbq(i,j,k)-(rvext_nbq_2d_sum(i,j)/nfast)*
<      &     (Hz_half(i,j,k)+Hz_half(i,j-1,k)))*on_v(i,j)*om_v(i,j)                 
< #else
<         l_nbq=ijk2lmom_nh(i,j,k,2)
<                  rv_nbq_avg2(i,j,k)=
<      &   ((qdm_nbq_a(l_nbq)-rv_nbq_avg2(i,j,k))/
<      &   (dt)-rvint_nbq(i,j,k)-(rvext_nbq_2d_sum(i,j)/nfast)*
<      &     (Hz_half(i,j,k)+Hz_half(i,j-1,k)))*on_v(i,j)*om_v(i,j)
< #endif
<               enddo
<             enddo 
<           enddo
<           do k=0,N
<             do j=Jstr,Jend
<               do i=Istr,Iend
<          !        rw_nbq_avg1(i,j,k)=rw_nbq_ext(i,j,k)
< #if defined NBQ_IJK
<                  rw_nbq_avg2(i,j,k)=
<      &   ((qdmw_nbq(i,j,k)-rw_nbq_avg2(i,j,k))/
<      &   (dt)-rwint_nbq(i,j,k))*on_r(i,j)*om_r(i,j)
< #else
<          l_nbq=ijk2lmom_nh(i,j,k,3)
<                  rw_nbq_avg2(i,j,k)=
<      &   ((qdm_nbq_a(l_nbq)-rw_nbq_avg2(i,j,k))/
<      &   (dt)-rwint_nbq(i,j,k))*on_r(i,j)*om_r(i,j)
< #endif
<               enddo
<             enddo 
<           enddo        
<         endif
< #endif        
1868,1869d1531
< 
< 
1888d1549
< 
1931,1932c1592,1593
<       enddo   
<   
---
>       enddo
>          
2022d1682
<       
2069d1728
< 
2088,2091c1747
< #endif  
< 
<          
<  
---
> #endif     
2101d1756
<           
step3d_t.F
step3d_uv1.F
step3d_uv2.F
step3d_w.F
88c88
< # undef NBQ_WDIF
---
> # define NBQ_WDIF
167,183d166
<       do j=Jstr,Jend
<       do i=Istr,Iend
<       wz(i,j,N,nnew)=0.5*(
<      &  u(i,j,N,nnew)*(z_w(i,j,N)-z_w(i-1,j,N))*pm_u(i,j)
<      & +u(i+1,j,N,nnew)*(z_w(i+1,j,N)-z_w(i,j,N))*pm_u(i+1,j)
<      & +v(i,j,N,nnew)*(z_w(i,j,N)-z_w(i,j-1,N))*pn_v(i,j)
<      & +v(i,j+1,N,nnew)*(z_w(i,j+1,N)-z_w(i,j,N))*pn_v(i,j+1))
<      & + (z_w(i,j,N)-zw_half_nbq(i,j,N))/(0.5*dt)
< 
<       wz(i,j,0,nnew)=-0.5*(
<      &  u(i,j,1,nnew)*(z_w(i,j,0)-z_w(i-1,j,0))*pm_u(i,j)
<      & +u(i+1,j,1,nnew)*(z_w(i+1,j,0)-z_w(i,j,0))*pm_u(i+1,j)
<      & +v(i,j,1,nnew)*(z_w(i,j,0)-z_w(i,j-1,0))*pn_v(i,j)
<      & +v(i,j+1,1,nnew)*(z_w(i,j+1,0)-z_w(i,j,0))*pn_v(i,j+1))
<       enddo
<       enddo
< 
step_floats.F
step_sta.F
t3dbc.F
t3dmix.F
t3dmix_ISO.F
t3dmix_S.F
t3dmix_spg.F
t3dpremix.F
testkeys.F
timers_roms.F
u2dbc.F
u3dbc.F
unbq_bc.F
15c15
< # if defined NBQ && !defined NBQ_IJK
---
> # ifdef NBQ
39c39
< # if defined NBQ && !defined NBQ_IJK
---
> # ifdef NBQ
50c50
< #if defined NBQ && !defined NBQ_IJK
---
> #ifdef NBQ
124,125c124,125
<             grad(Istr  ,j)=(qdm_nbq_a(l_b_j  )
<      &                     -qdm_nbq_a(l_b_jm1)*mask1_u)
---
>             grad(Istr  ,j)=(qdm_nbq_a(l_b_j  ,vnstp_nbq)
>      &                     -qdm_nbq_a(l_b_jm1,vnstp_nbq)*mask1_u)
129,130c129,130
<             grad(Istr+1,j)=(qdm_nbq_a(l_bm1_j  )
<      &                     -qdm_nbq_a(l_bm1_jm1)*mask2_u)
---
>             grad(Istr+1,j)=(qdm_nbq_a(l_bm1_j  ,vnstp_nbq)
>      &                     -qdm_nbq_a(l_bm1_jm1,vnstp_nbq)*mask2_u)
141,142c141,142
<           dft=qdm_nbq_a(l_bm1_j )-qdm_nbq_a(l_bm1_j)
<           dfx=qdm_nbq_a(l_bm1_j )-qdm_nbq_a(l_bm2_j)
---
>           dft=qdm_nbq_a(l_bm1_j ,vnstp_nbq)-qdm_nbq_a(l_bm1_j,vnnew_nbq)
>           dfx=qdm_nbq_a(l_bm1_j ,vnnew_nbq)-qdm_nbq_a(l_bm2_j,vnnew_nbq)
171,173c171,173
<             qdm_nbq_a(l_b_j)=( 
<      &                              cff*qdm_nbq_a(l_b_j  )
<      &                              +cx*qdm_nbq_a(l_bm1_j)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=( 
>      &                              cff*qdm_nbq_a(l_b_j  ,vnstp_nbq)
>      &                              +cx*qdm_nbq_a(l_bm1_j,vnnew_nbq)
178c178
<           qdm_nbq_a(l_b_j)=(1.-tau)*qdm_nbq_a(l_b_j)
---
>           qdm_nbq_a(l_b_j,vnnew_nbq)=(1.-tau)*qdm_nbq_a(l_b_j,vnnew_nbq)
191c191
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=qdm_nbq_a(l_b_j,vnnew_nbq)
195c195
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=qdm_nbq_a(l_b_j,vnnew_nbq)
208c208
<             qdm_nbq_a(l_b_j)=unbqbry_west(j,k)         ! specified
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=unbqbry_west(j,k)         ! specified
210c210
<             qdm_nbq_a(l_b_j)=unbqclm(Istr,j,k)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=unbqclm(Istr,j,k)
227,228c227,228
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_bm1_j) ! Gradient: default
< !           qdm_nbq_a(l_b_j)=u(Istr,j,k,nnew)*rho0 ! Gradient: default
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=qdm_nbq_a(l_bm1_j,vnnew_nbq) ! Gradient: default
> !           qdm_nbq_a(l_b_j,vnnew_nbq)=u(Istr,j,k,nnew)*rho0 ! Gradient: default
243c243
< !            qdm_nbq_a(l_b_j)=0. 
---
> !            qdm_nbq_a(l_b_j,vnnew_nbq)=0. 
275,276c275,276
<             grad(Iend  ,j)=(qdm_nbq_a(l_bm1_j  )
<      &                     -qdm_nbq_a(l_bm1_jm1)*mask1_u)
---
>             grad(Iend  ,j)=(qdm_nbq_a(l_bm1_j  ,vnstp_nbq)
>      &                     -qdm_nbq_a(l_bm1_jm1,vnstp_nbq)*mask1_u)
280,281c280,281
<             grad(Iend+1,j)=(qdm_nbq_a(l_b_j  )
<      &                     -qdm_nbq_a(l_b_jm1)*mask2_u)
---
>             grad(Iend+1,j)=(qdm_nbq_a(l_b_j  ,vnstp_nbq)
>      &                     -qdm_nbq_a(l_b_jm1,vnstp_nbq)*mask2_u)
292,293c292,293
<           dft=qdm_nbq_a(l_bm1_j )-qdm_nbq_a(l_bm1_j)
<           dfx=qdm_nbq_a(l_bm1_j )-qdm_nbq_a(l_bm2_j)
---
>           dft=qdm_nbq_a(l_bm1_j ,vnstp_nbq)-qdm_nbq_a(l_bm1_j,vnnew_nbq)
>           dfx=qdm_nbq_a(l_bm1_j ,vnnew_nbq)-qdm_nbq_a(l_bm2_j,vnnew_nbq)
322,323c322,323
<            qdm_nbq_a(l_b_j)=( cff*qdm_nbq_a(l_b_j  )
<      &                              +cx*qdm_nbq_a(l_bm1_j)
---
>            qdm_nbq_a(l_b_j,vnnew_nbq)=( cff*qdm_nbq_a(l_b_j  ,vnstp_nbq)
>      &                              +cx*qdm_nbq_a(l_bm1_j,vnnew_nbq)
328c328
<           qdm_nbq_a(l_b_j)=(1.-tau)*qdm_nbq_a(l_b_j)
---
>           qdm_nbq_a(l_b_j,vnnew_nbq)=(1.-tau)*qdm_nbq_a(l_b_j,vnnew_nbq)
341c341
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=qdm_nbq_a(l_b_j,vnnew_nbq)
345c345
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=qdm_nbq_a(l_b_j,vnnew_nbq)
358c358
<             qdm_nbq_a(l_b_j)=unbqbry_east(j,k)       ! specified
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=unbqbry_east(j,k)       ! specified
360c360
<             qdm_nbq_a(l_b_j)=unbqclm(Iend+1,j,k)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=unbqclm(Iend+1,j,k)
377,378c377,378
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_bm1_j)  ! gradient (default)
< !           qdm_nbq_a(l_b_j)=u(Iend+1,j,k,nnew)*rho0  ! gradient (default)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=qdm_nbq_a(l_bm1_j,vnnew_nbq)  ! gradient (default)
> !           qdm_nbq_a(l_b_j,vnnew_nbq)=u(Iend+1,j,k,nnew)*rho0  ! gradient (default)
393c393
< !             qdm_nbq_a(l_b_j)=0.               
---
> !             qdm_nbq_a(l_b_j,vnnew_nbq)=0.               
416,419c416,419
<             grad(i,Jstr-1)=qdm_nbq_a(l_b_ip1  )
<      &                    -qdm_nbq_a(l_b_i    )
<             grad(i,Jstr  )=qdm_nbq_a(l_bm1_ip1)
<      &                    -qdm_nbq_a(l_bm1_i  )
---
>             grad(i,Jstr-1)=qdm_nbq_a(l_b_ip1  ,vnstp_nbq)
>      &                    -qdm_nbq_a(l_b_i    ,vnstp_nbq)
>             grad(i,Jstr  )=qdm_nbq_a(l_bm1_ip1,vnstp_nbq)
>      &                    -qdm_nbq_a(l_bm1_i  ,vnstp_nbq)
427,430c427,430
<             dft=qdm_nbq_a(l_bm1_i )
<      &         -qdm_nbq_a(l_bm1_i)
<             dfx=qdm_nbq_a(l_bm1_i )
<      &         -qdm_nbq_a(l_bm2_i)
---
>             dft=qdm_nbq_a(l_bm1_i ,vnstp_nbq)
>      &         -qdm_nbq_a(l_bm1_i,vnnew_nbq)
>             dfx=qdm_nbq_a(l_bm1_i ,vnnew_nbq)
>      &         -qdm_nbq_a(l_bm2_i,vnnew_nbq)
457,458c457,458
<            qdm_nbq_a(l_b_i)=( cff*qdm_nbq_a(l_b_i  )
<      &                              +cx*qdm_nbq_a(l_bm1_i)
---
>            qdm_nbq_a(l_b_i,vnnew_nbq)=( cff*qdm_nbq_a(l_b_i  ,vnstp_nbq)
>      &                              +cx*qdm_nbq_a(l_bm1_i,vnnew_nbq)
463c463
<           qdm_nbq_a(l_b_i)=(1.-tau)*qdm_nbq_a(l_b_i)
---
>           qdm_nbq_a(l_b_i,vnnew_nbq)=(1.-tau)*qdm_nbq_a(l_b_i,vnnew_nbq)
471c471
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_b_i)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=qdm_nbq_a(l_b_i,vnnew_nbq)
475c475
<             unbq(i,Jstr-1,k)=unbq(i,Jstr-1,k)
---
>             unbq(i,Jstr-1,k,vnnew_nbq)=unbq(i,Jstr-1,k,vnnew_nbq)
488c488
<             qdm_nbq_a(l_b_i)=unbqbry_south(i,k)      ! specified
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=unbqbry_south(i,k)      ! specified
490c490
<             qdm_nbq_a(l_b_i)=unbqclm(i,Jstr-1,k)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=unbqclm(i,Jstr-1,k)
507c507
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_bm1_i) ! gradient (default)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=qdm_nbq_a(l_bm1_i,vnnew_nbq) ! gradient (default)
527c527
< !            qdm_nbq_a(l_b_i)=gamma2*qdm_nbq_a(l_bm1_i)
---
> !            qdm_nbq_a(l_b_i,vnnew_nbq)=gamma2*qdm_nbq_a(l_bm1_i,vnnew_nbq)
551,554c551,554
<             grad(i,Jend+1)=qdm_nbq_a(l_b_ip1  )
<      &                    -qdm_nbq_a(l_b_i    )
<             grad(i,Jend  )=qdm_nbq_a(l_bm1_ip1)
<      &                    -qdm_nbq_a(l_bm1_i  )
---
>             grad(i,Jend+1)=qdm_nbq_a(l_b_ip1  ,vnstp_nbq)
>      &                    -qdm_nbq_a(l_b_i    ,vnstp_nbq)
>             grad(i,Jend  )=qdm_nbq_a(l_bm1_ip1,vnstp_nbq)
>      &                    -qdm_nbq_a(l_bm1_i  ,vnstp_nbq)
563,564c563,564
<             dft=qdm_nbq_a(l_bm1_i )-qdm_nbq_a(l_bm1_i)
<             dfx=qdm_nbq_a(l_bm1_i )-qdm_nbq_a(l_bm2_i)
---
>             dft=qdm_nbq_a(l_bm1_i ,vnstp_nbq)-qdm_nbq_a(l_bm1_i,vnnew_nbq)
>             dfx=qdm_nbq_a(l_bm1_i ,vnnew_nbq)-qdm_nbq_a(l_bm2_i,vnnew_nbq)
592,593c592,593
<             qdm_nbq_a(l_b_i)=( cff*qdm_nbq_a(l_b_i)
<      &                              +cx*qdm_nbq_a(l_bm1_i)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=( cff*qdm_nbq_a(l_b_i  ,vnstp_nbq)
>      &                              +cx*qdm_nbq_a(l_bm1_i,vnnew_nbq)
598c598
<             qdm_nbq_a(l_b_i)=(1.-tau)*qdm_nbq_a(l_b_i)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=(1.-tau)*qdm_nbq_a(l_b_i,vnnew_nbq)
606c606
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_b_i)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=qdm_nbq_a(l_b_i,vnnew_nbq)
610c610
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_b_i)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=qdm_nbq_a(l_b_i,vnnew_nbq)
623c623
<             qdm_nbq_a(l_b_i)=unbqbry_north(i,k)      ! specified
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=unbqbry_north(i,k)      ! specified
625c625
<             qdm_nbq_a(l_b_i)=unbqclm(i,Jend+1,k)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=unbqclm(i,Jend+1,k)
642c642
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_bm1_i)  ! gradient (default)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=qdm_nbq_a(l_bm1_i,vnnew_nbq)  ! gradient (default)
662c662
< !            qdm_nbq_a(l_b_i)=gamma2*qdm_nbq_a(l_bm1_i)
---
> !            qdm_nbq_a(l_b_i,vnnew_nbq)=gamma2*qdm_nbq_a(l_bm1_i,vnnew_nbq)
682,683c682,683
<           qdm_nbq_a(l_c)=0.5*(qdm_nbq_a(l_c_im1)
<      &                            +qdm_nbq_a(l_c_jm1))
---
>           qdm_nbq_a(l_c,vnnew_nbq)=0.5*(qdm_nbq_a(l_c_im1,vnnew_nbq)
>      &                            +qdm_nbq_a(l_c_jm1,vnnew_nbq))
696,697c696,697
<           qdm_nbq_a(l_c)=0.5*(qdm_nbq_a(l_c_im1)
<      &                            +qdm_nbq_a(l_c_jm1))
---
>           qdm_nbq_a(l_c,vnnew_nbq)=0.5*(qdm_nbq_a(l_c_im1,vnnew_nbq)
>      &                            +qdm_nbq_a(l_c_jm1,vnnew_nbq))
710,711c710,711
<           qdm_nbq_a(l_c)=0.5*(qdm_nbq_a(l_c_im1)
<      &                            +qdm_nbq_a(l_c_jm1))
---
>           qdm_nbq_a(l_c,vnnew_nbq)=0.5*(qdm_nbq_a(l_c_im1,vnnew_nbq)
>      &                            +qdm_nbq_a(l_c_jm1,vnnew_nbq))
724,725c724,725
<           qdm_nbq_a(l_c)=0.5*(qdm_nbq_a(l_c_im1)
<      &                            +qdm_nbq_a(l_c_jm1))
---
>           qdm_nbq_a(l_c,vnnew_nbq)=0.5*(qdm_nbq_a(l_c_im1,vnnew_nbq)
>      &                            +qdm_nbq_a(l_c_jm1,vnnew_nbq))
unbqijk_bc.F
update2D.F
update3D.F
uv3dmix.F
uv3dmix4_GP.F
uv3dmix4_S.F
uv3dmix_GP.F
uv3dmix_S.F
uv3dmix_spg.F
uv3dpremix.F
v2dbc.F
v3dbc.F
vnbq_bc.F
15c15
< # if defined NBQ && !defined NBQ_IJK
---
> # ifdef NBQ
40c40
< # if defined NBQ && !defined NBQ_IJK
---
> # ifdef NBQ
51c51
< # if defined NBQ && !defined NBQ_IJK
---
> #ifdef NBQ
121,122c121,122
<             grad(i,Jstr  )=(qdm_nbq_a(l_b_i  )
<      &                     -qdm_nbq_a(l_b_im1)*mask1_v)
---
>             grad(i,Jstr  )=(qdm_nbq_a(l_b_i  ,vnstp_nbq)
>      &                     -qdm_nbq_a(l_b_im1,vnstp_nbq)*mask1_v)
126,127c126,127
<             grad(i,Jstr+1)=(qdm_nbq_a(l_bm1_i  )
<      &                     -qdm_nbq_a(l_bm1_im1)*mask2_v)
---
>             grad(i,Jstr+1)=(qdm_nbq_a(l_bm1_i  ,vnstp_nbq)
>      &                     -qdm_nbq_a(l_bm1_im1,vnstp_nbq)*mask2_v)
138,139c138,139
<            dft=qdm_nbq_a(l_bm1_i)-qdm_nbq_a(l_bm1_i)
<            dfx=qdm_nbq_a(l_bm1_i)-qdm_nbq_a(l_bm2_i)
---
>            dft=qdm_nbq_a(l_bm1_i,vnstp_nbq)-qdm_nbq_a(l_bm1_i,vnnew_nbq)
>            dfx=qdm_nbq_a(l_bm1_i,vnnew_nbq)-qdm_nbq_a(l_bm2_i,vnnew_nbq)
167,168c167,168
<            qdm_nbq_a(l_b_i)=( cff*qdm_nbq_a(l_b_i  )
<      &                              +cx*qdm_nbq_a(l_bm1_i)
---
>            qdm_nbq_a(l_b_i,vnnew_nbq)=( cff*qdm_nbq_a(l_b_i  ,vnstp_nbq)
>      &                              +cx*qdm_nbq_a(l_bm1_i,vnnew_nbq)
173c173
<           qdm_nbq_a(l_b_i)=(1.-tau)*qdm_nbq_a(l_b_i)
---
>           qdm_nbq_a(l_b_i,vnnew_nbq)=(1.-tau)*qdm_nbq_a(l_b_i,vnnew_nbq)
185c185
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_b_i)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=qdm_nbq_a(l_b_i,vnnew_nbq)
189c189
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_b_i)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=qdm_nbq_a(l_b_i,vnnew_nbq)
201c201
<             qdm_nbq_a(l_b_i)=vnbqbry_south(i,k)        ! specified
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=vnbqbry_south(i,k)        ! specified
203c203
<             qdm_nbq_a(l_b_i)=vnbqclm(i,Jstr,k)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=vnbqclm(i,Jstr,k)
220c220
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_bm1_i)  ! gradient (default)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=qdm_nbq_a(l_bm1_i,vnnew_nbq)  ! gradient (default)
234c234
< !            qdm_nbq_a(l_b_i)=0.
---
> !            qdm_nbq_a(l_b_i,vnnew_nbq)=0.
266,267c266,267
<             grad(i,Jend  )=(qdm_nbq_a(l_bm1_j  )
<      &                     -qdm_nbq_a(l_bm1_im1)*mask1_v)
---
>             grad(i,Jend  )=(qdm_nbq_a(l_bm1_j  ,vnstp_nbq)
>      &                     -qdm_nbq_a(l_bm1_im1,vnstp_nbq)*mask1_v)
271,272c271,272
<             grad(i,Jend+1)=(qdm_nbq_a(l_b_j  )
<      &                     -qdm_nbq_a(l_b_im1)*mask2_v)
---
>             grad(i,Jend+1)=(qdm_nbq_a(l_b_j  ,vnstp_nbq)
>      &                     -qdm_nbq_a(l_b_im1,vnstp_nbq)*mask2_v)
283,284c283,284
<            dft=qdm_nbq_a(l_bm1_i)-qdm_nbq_a(l_bm1_i)
<            dfx=qdm_nbq_a(l_bm1_i)-qdm_nbq_a(l_bm2_i)
---
>            dft=qdm_nbq_a(l_bm1_i,vnstp_nbq)-qdm_nbq_a(l_bm1_i,vnnew_nbq)
>            dfx=qdm_nbq_a(l_bm1_i,vnnew_nbq)-qdm_nbq_a(l_bm2_i,vnnew_nbq)
312,313c312,313
<            qdm_nbq_a(l_b_i)=( cff*qdm_nbq_a(l_b_i  )
<      &                              +cx*qdm_nbq_a(l_bm1_i)
---
>            qdm_nbq_a(l_b_i,vnnew_nbq)=( cff*qdm_nbq_a(l_b_i  ,vnstp_nbq)
>      &                              +cx*qdm_nbq_a(l_bm1_i,vnnew_nbq)
318c318
<           qdm_nbq_a(l_b_i)=(1.-tau)*qdm_nbq_a(l_b_i)
---
>           qdm_nbq_a(l_b_i,vnnew_nbq)=(1.-tau)*qdm_nbq_a(l_b_i,vnnew_nbq)
330c330
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_b_i)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=qdm_nbq_a(l_b_i,vnnew_nbq)
334c334
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_b_i)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=qdm_nbq_a(l_b_i,vnnew_nbq)
347c347
<             qdm_nbq_a(l_b_i)=vnbqbry_north(i,k)      ! specified
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=vnbqbry_north(i,k)      ! specified
349c349
<             qdm_nbq_a(l_b_i)=vnbqclm(i,Jend+1,k)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=vnbqclm(i,Jend+1,k)
366c366
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_bm1_i) ! gradient (default)
---
>             qdm_nbq_a(l_b_i,vnnew_nbq)=qdm_nbq_a(l_bm1_i,vnnew_nbq) ! gradient (default)
380c380
< !            qdm_nbq_a(l_b_i)=0.
---
> !            qdm_nbq_a(l_b_i,vnnew_nbq)=0.
403,406c403,406
<             grad(Istr-1,j)=qdm_nbq_a(l_b_jp1  )
<      &                    -qdm_nbq_a(l_b_j    )
<             grad(Istr  ,j)=qdm_nbq_a(l_bm1_jp1)
<      &                    -qdm_nbq_a(l_bm1_j  )
---
>             grad(Istr-1,j)=qdm_nbq_a(l_b_jp1  ,vnstp_nbq)
>      &                    -qdm_nbq_a(l_b_j    ,vnstp_nbq)
>             grad(Istr  ,j)=qdm_nbq_a(l_bm1_jp1,vnstp_nbq)
>      &                    -qdm_nbq_a(l_bm1_j  ,vnstp_nbq)
414,415c414,415
<            dft=qdm_nbq_a(l_bm1_j)  -qdm_nbq_a(l_bm1_j)
<            dfx=qdm_nbq_a(l_bm1_j)  -qdm_nbq_a(l_bm2_j)
---
>            dft=qdm_nbq_a(l_bm1_j,vnstp_nbq)  -qdm_nbq_a(l_bm1_j,vnnew_nbq)
>            dfx=qdm_nbq_a(l_bm1_j,vnnew_nbq)  -qdm_nbq_a(l_bm2_j,vnnew_nbq)
442,443c442,443
<           qdm_nbq_a(l_b_j)=( cff*qdm_nbq_a(l_b_j  )
<      &                              +cx*qdm_nbq_a(l_bm1_j)
---
>           qdm_nbq_a(l_b_j,vnnew_nbq)=( cff*qdm_nbq_a(l_b_j  ,vnstp_nbq)
>      &                              +cx*qdm_nbq_a(l_bm1_j,vnnew_nbq)
448c448
<           qdm_nbq_a(l_b_j)=(1.-tau)*qdm_nbq_a(l_b_j)
---
>           qdm_nbq_a(l_b_j,vnnew_nbq)=(1.-tau)*qdm_nbq_a(l_b_j,vnnew_nbq)
457c457
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=qdm_nbq_a(l_b_j,vnnew_nbq)
461c461
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=qdm_nbq_a(l_b_j,vnnew_nbq)
474c474
<             qdm_nbq_a(l_b_j)=vnbqbry_west(j,k)       ! specified
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=vnbqbry_west(j,k)       ! specified
476c476
<             qdm_nbq_a(l_b_j)=vnbqclm(Istr-1,j,k)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=vnbqclm(Istr-1,j,k)
493,494c493,494
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_bm1_j) ! gradient (default)
< !           qdm_nbq_a(l_b_j)=v(Istr-1,j,k,nnew) ! gradient (default)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=qdm_nbq_a(l_bm1_j,vnnew_nbq) ! gradient (default)
> !           qdm_nbq_a(l_b_j,vnnew_nbq)=v(Istr-1,j,k,nnew) ! gradient (default)
514c514
< !            qdm_nbq_a(l_b_j)=gamma2*qdm_nbq_a(l_bm1_j)
---
> !            qdm_nbq_a(l_b_j,vnnew_nbq)=gamma2*qdm_nbq_a(l_bm1_j,vnnew_nbq)
538,541c538,541
<             grad(Iend+1,j)=qdm_nbq_a(l_b_jp1  )
<      &                    -qdm_nbq_a(l_b_j    )
<             grad(Iend  ,j)=qdm_nbq_a(l_bm1_jp1)
<      &                    -qdm_nbq_a(l_bm1_j  )
---
>             grad(Iend+1,j)=qdm_nbq_a(l_b_jp1  ,vnstp_nbq)
>      &                    -qdm_nbq_a(l_b_j    ,vnstp_nbq)
>             grad(Iend  ,j)=qdm_nbq_a(l_bm1_jp1,vnstp_nbq)
>      &                    -qdm_nbq_a(l_bm1_j  ,vnstp_nbq)
549,550c549,550
<             dft=qdm_nbq_a(l_bm1_j)  -qdm_nbq_a(l_bm1_j)
<             dfx=qdm_nbq_a(l_bm1_j)  -qdm_nbq_a(l_bm2_j)
---
>             dft=qdm_nbq_a(l_bm1_j,vnstp_nbq)  -qdm_nbq_a(l_bm1_j,vnnew_nbq)
>             dfx=qdm_nbq_a(l_bm1_j,vnnew_nbq)  -qdm_nbq_a(l_bm2_j,vnnew_nbq)
578,579c578,579
<            qdm_nbq_a(l_b_j)=( cff*qdm_nbq_a(l_b_j)
<      &                              +cx*qdm_nbq_a(l_bm1_j)
---
>            qdm_nbq_a(l_b_j,vnnew_nbq)=( cff*qdm_nbq_a(l_b_j  ,vnstp_nbq)
>      &                              +cx*qdm_nbq_a(l_bm1_j,vnnew_nbq)
584c584
<           qdm_nbq_a(l_b_j)=(1.-tau)*qdm_nbq_a(l_b_j)
---
>           qdm_nbq_a(l_b_j,vnnew_nbq)=(1.-tau)*qdm_nbq_a(l_b_j,vnnew_nbq)
593c593
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=qdm_nbq_a(l_b_j,vnnew_nbq)
597c597
<            qdm_nbq_a(l_b_j)=qdm_nbq_a(l_b_j)
---
>            qdm_nbq_a(l_b_j,vnnew_nbq)=qdm_nbq_a(l_b_j,vnnew_nbq)
610c610
<             qdm_nbq_a(l_b_j)=vnbqbry_east(j,k)       ! specified
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=vnbqbry_east(j,k)       ! specified
612c612
<             qdm_nbq_a(l_b_j)=vnbqclm(Iend+1,j,k)
---
>             qdm_nbq_a(l_b_j,vnnew_nbq)=vnbqclm(Iend+1,j,k)
629,630c629,630
<            qdm_nbq_a(l_b_j)=qdm_nbq_a(l_bm1_j) ! gradient (default)
< !          qdm_nbq_a(l_b_j)=v(Iend+1,j,k,nnew) ! gradient (default)
---
>            qdm_nbq_a(l_b_j,vnnew_nbq)=qdm_nbq_a(l_bm1_j,vnnew_nbq) ! gradient (default)
> !          qdm_nbq_a(l_b_j,vnnew_nbq)=v(Iend+1,j,k,nnew) ! gradient (default)
650c650
< !            qdm_nbq_a(l_b_j)=gamma2*qdm_nbq_a(l_bm1_j)
---
> !            qdm_nbq_a(l_b_j,vnnew_nbq)=gamma2*qdm_nbq_a(l_bm1_j,vnnew_nbq)
670,671c670,671
<           qdm_nbq_a(l_c)=0.5*(qdm_nbq_a(l_c_jm1)
<      &                            +qdm_nbq_a(l_c_im1))
---
>           qdm_nbq_a(l_c,vnnew_nbq)=0.5*(qdm_nbq_a(l_c_jm1,vnnew_nbq)
>      &                            +qdm_nbq_a(l_c_im1,vnnew_nbq))
684,685c684,685
<           qdm_nbq_a(l_c)=0.5*(qdm_nbq_a(l_c_jm1)
<      &                            +qdm_nbq_a(l_c_im1))
---
>           qdm_nbq_a(l_c,vnnew_nbq)=0.5*(qdm_nbq_a(l_c_jm1,vnnew_nbq)
>      &                            +qdm_nbq_a(l_c_im1,vnnew_nbq))
698,699c698,699
<           qdm_nbq_a(l_c)=0.5*(qdm_nbq_a(l_c_jm1)
<      &                            +qdm_nbq_a(l_c_im1))
---
>           qdm_nbq_a(l_c,vnnew_nbq)=0.5*(qdm_nbq_a(l_c_jm1,vnnew_nbq)
>      &                            +qdm_nbq_a(l_c_im1,vnnew_nbq))
712,713c712,713
<           qdm_nbq_a(l_c)=0.5*(qdm_nbq_a(l_c_jm1)
<      &                            +qdm_nbq_a(l_c_im1))
---
>           qdm_nbq_a(l_c,vnnew_nbq)=0.5*(qdm_nbq_a(l_c_jm1,vnnew_nbq)
>      &                            +qdm_nbq_a(l_c_im1,vnnew_nbq))
vnbqijk_bc.F
w3dbc.F
74,75c74,75
<       tau_in=dt*tauM_in
<       tau_out=dt*tauM_out
---
>       tau_in=dt*tauM_in/100.
>       tau_out=dt*tauM_out/100.
wetdry.F
wkb_wwave.F
wkbbc.F
wnbq_bc.F
15c15
< # if defined NBQ && !defined NBQ_IJK
---
> # ifdef NBQ
39c39
< # if defined NBQ && !defined NBQ_IJK
---
> # ifdef NBQ
50c50
< # if defined NBQ && !defined NBQ_IJK
---
> #ifdef NBQ
110,111c110,111
<             grad(Istr-1,j)=(qdm_nbq_a(l_b_j  )
<      &                     -qdm_nbq_a(l_b_jm1))
---
>             grad(Istr-1,j)=(qdm_nbq_a(l_b_j  ,nstp)
>      &                     -qdm_nbq_a(l_b_jm1,nstp))
115,116c115,116
<             grad(Istr  ,j)=(qdm_nbq_a(l_bm1_j  )
<      &                     -qdm_nbq_a(l_bm1_jm1))
---
>             grad(Istr  ,j)=(qdm_nbq_a(l_bm1_j  ,nstp)
>      &                     -qdm_nbq_a(l_bm1_jm1,nstp))
127,128c127,128
<             dft=qdm_nbq_a(l_bm1_j)-qdm_nbq_a(l_bm1_j)
<             dfx=qdm_nbq_a(l_bm1_j)-qdm_nbq_a(l_bm2_j)
---
>             dft=qdm_nbq_a(l_bm1_j,nstp)-qdm_nbq_a(l_bm1_j,nnew)
>             dfx=qdm_nbq_a(l_bm1_j,nnew)-qdm_nbq_a(l_bm2_j,nnew)
156,157c156,157
<             qdm_nbq_a(l_b_j)=( cff*qdm_nbq_a(l_b_j  )
<      &                              +cx*qdm_nbq_a(l_bm1_j)
---
>             qdm_nbq_a(l_b_j,nnew)=( cff*qdm_nbq_a(l_b_j  ,nstp)
>      &                              +cx*qdm_nbq_a(l_bm1_j,nnew)
162c162
<             qdm_nbq_a(l_b_j)=(1.-tau)*qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,nnew)=(1.-tau)*qdm_nbq_a(l_b_j,nnew)
170c170
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,nnew)=qdm_nbq_a(l_b_j,nnew)
174c174
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,nnew)=qdm_nbq_a(l_b_j,nnew)
187c187
<             qdm_nbq_a(l_b_j)=wnbqbry_west(j,k)         ! specified
---
>             qdm_nbq_a(l_b_j,nnew)=wnbqbry_west(j,k)         ! specified
189c189
<             qdm_nbq_a(l_b_j)=wnbqclm(Istr-1,j,k)
---
>             qdm_nbq_a(l_b_j,nnew)=wnbqclm(Istr-1,j,k)
206c206
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_bm1_j) ! Gradient: default
---
>             qdm_nbq_a(l_b_j,nnew)=qdm_nbq_a(l_bm1_j,nnew) ! Gradient: default
221c221
< !            qdm_nbq_a(l_b_j)=0.           
---
> !            qdm_nbq_a(l_b_j,nnew)=0.           
241,242c241,242
<             grad(Iend  ,j)=(qdm_nbq_a(l_bm1_j  )
<      &                     -qdm_nbq_a(l_bm1_jm1))
---
>             grad(Iend  ,j)=(qdm_nbq_a(l_bm1_j  ,nstp)
>      &                     -qdm_nbq_a(l_bm1_jm1,nstp))
246,247c246,247
<             grad(Iend+1,j)=(qdm_nbq_a(l_b_j  )
<      &                     -qdm_nbq_a(l_b_jm1))
---
>             grad(Iend+1,j)=(qdm_nbq_a(l_b_j  ,nstp)
>      &                     -qdm_nbq_a(l_b_jm1,nstp))
258,259c258,259
<             dft=qdm_nbq_a(l_bm1_j)-qdm_nbq_a(l_bm1_j)
<             dfx=qdm_nbq_a(l_bm1_j)-qdm_nbq_a(l_bm2_j)
---
>             dft=qdm_nbq_a(l_bm1_j,nstp)-qdm_nbq_a(l_bm1_j,nnew)
>             dfx=qdm_nbq_a(l_bm1_j,nnew)-qdm_nbq_a(l_bm2_j,nnew)
287,288c287,288
<             qdm_nbq_a(l_b_j)=( cff*qdm_nbq_a(l_b_j  )
<      &                              +cx*qdm_nbq_a(l_bm1_j)
---
>             qdm_nbq_a(l_b_j,nnew)=( cff*qdm_nbq_a(l_b_j  ,nstp)
>      &                              +cx*qdm_nbq_a(l_bm1_j,nnew)
293c293
<             qdm_nbq_a(l_b_j)=(1.-tau)*qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,nnew)=(1.-tau)*qdm_nbq_a(l_b_j,nnew)
301c301
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,nnew)=qdm_nbq_a(l_b_j,nnew)
305c305
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_b_j)
---
>             qdm_nbq_a(l_b_j,nnew)=qdm_nbq_a(l_b_j,nnew)
318c318
<              qdm_nbq_a(l_b_j)=wnbqbry_east(j,k)       ! specified
---
>              qdm_nbq_a(l_b_j,nnew)=wnbqbry_east(j,k)       ! specified
320c320
<              qdm_nbq_a(l_b_j)=wnbqclm(Iend+1,j,k)
---
>              qdm_nbq_a(l_b_j,nnew)=wnbqclm(Iend+1,j,k)
337c337
<             qdm_nbq_a(l_b_j)=qdm_nbq_a(l_bm1_j)  ! gradient (default)
---
>             qdm_nbq_a(l_b_j,nnew)=qdm_nbq_a(l_bm1_j,nnew)  ! gradient (default)
352c352
< !             qdm_nbq_a(l_b_j)=0.
---
> !             qdm_nbq_a(l_b_j,nnew)=0.
375,376c375,376
<             grad(i,Jstr-1)=(qdm_nbq_a(l_b_i  )
<      &                     -qdm_nbq_a(l_b_im1))
---
>             grad(i,Jstr-1)=(qdm_nbq_a(l_b_i  ,nstp)
>      &                     -qdm_nbq_a(l_b_im1,nstp))
380,381c380,381
<             grad(i,Jstr  )=(qdm_nbq_a(l_bm1_i  )
<      &                     -qdm_nbq_a(l_bm1_im1))
---
>             grad(i,Jstr  )=(qdm_nbq_a(l_bm1_i  ,nstp)
>      &                     -qdm_nbq_a(l_bm1_im1,nstp))
392,393c392,393
<             dft=qdm_nbq_a(l_bm1_i)-qdm_nbq_a(l_bm1_i)
<             dfx=qdm_nbq_a(l_bm1_i)-qdm_nbq_a(l_bm2_i)
---
>             dft=qdm_nbq_a(l_bm1_i,nstp)-qdm_nbq_a(l_bm1_i,nnew)
>             dfx=qdm_nbq_a(l_bm1_i,nnew)-qdm_nbq_a(l_bm2_i,nnew)
421,422c421,422
<             qdm_nbq_a(l_b_i)=( cff*qdm_nbq_a(l_b_i  )
<      &                              +cx*qdm_nbq_a(l_bm1_i)
---
>             qdm_nbq_a(l_b_i,nnew)=( cff*qdm_nbq_a(l_b_i  ,nstp)
>      &                              +cx*qdm_nbq_a(l_bm1_i,nnew)
427c427
<             qdm_nbq_a(l_b_i)=(1.-tau)*qdm_nbq_a(l_b_i)
---
>             qdm_nbq_a(l_b_i,nnew)=(1.-tau)*qdm_nbq_a(l_b_i,nnew)
435c435
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_b_i)*rmask(i,Jstr-1)
---
>             qdm_nbq_a(l_b_i,nnew)=qdm_nbq_a(l_b_i,nnew)*rmask(i,Jstr-1)
438c438
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_b_i)
---
>             qdm_nbq_a(l_b_i,nnew)=qdm_nbq_a(l_b_i,nnew)
450c450
<             qdm_nbq_a(l_b_i)=wnbqbry_south(i,k)        ! specified
---
>             qdm_nbq_a(l_b_i,nnew)=wnbqbry_south(i,k)        ! specified
452c452
<             qdm_nbq_a(l_b_i)=wnbqclm(i,Jstr-1,k)
---
>             qdm_nbq_a(l_b_i,nnew)=wnbqclm(i,Jstr-1,k)
469c469
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_bm1_i)  ! gradient (default)
---
>             qdm_nbq_a(l_b_i,nnew)=qdm_nbq_a(l_bm1_i,nnew)  ! gradient (default)
483c483
< !            qdm_nbq_a(l_b_i)=0.
---
> !            qdm_nbq_a(l_b_i,nnew)=0.
503,504c503,504
<             grad(i,Jend  )=(qdm_nbq_a(l_bm1_j  )
<      &                     -qdm_nbq_a(l_bm1_im1))
---
>             grad(i,Jend  )=(qdm_nbq_a(l_bm1_j  ,nstp)
>      &                     -qdm_nbq_a(l_bm1_im1,nstp))
508,509c508,509
<             grad(i,Jend+1)=(qdm_nbq_a(l_b_j  )
<      &                     -qdm_nbq_a(l_b_im1))
---
>             grad(i,Jend+1)=(qdm_nbq_a(l_b_j  ,nstp)
>      &                     -qdm_nbq_a(l_b_im1,nstp))
520,521c520,521
<             dft=qdm_nbq_a(l_bm1_i)-qdm_nbq_a(l_bm1_i)
<             dfx=qdm_nbq_a(l_bm1_i)-qdm_nbq_a(l_bm2_i)
---
>             dft=qdm_nbq_a(l_bm1_i,nstp)-qdm_nbq_a(l_bm1_i,nnew)
>             dfx=qdm_nbq_a(l_bm1_i,nnew)-qdm_nbq_a(l_bm2_i,nnew)
549,550c549,550
<             qdm_nbq_a(l_b_i)=( cff*qdm_nbq_a(l_b_i)
<      &                              +cx*qdm_nbq_a(l_bm1_i)
---
>             qdm_nbq_a(l_b_i,nnew)=( cff*qdm_nbq_a(l_b_i  ,nstp)
>      &                              +cx*qdm_nbq_a(l_bm1_i,nnew)
555c555
<             qdm_nbq_a(l_b_i)=(1.-tau)*qdm_nbq_a(l_b_i)
---
>             qdm_nbq_a(l_b_i,nnew)=(1.-tau)*qdm_nbq_a(l_b_i,nnew)
563c563
<           qdm_nbq_a(l_b_i)=qdm_nbq_a(l_b_i)*rmask(i,Jend+1)
---
>           qdm_nbq_a(l_b_i,nnew)=qdm_nbq_a(l_b_i,nnew)*rmask(i,Jend+1)
566c566
<           qdm_nbq_a(l_b_i)=qdm_nbq_a(l_b_i)
---
>           qdm_nbq_a(l_b_i,nnew)=qdm_nbq_a(l_b_i,nnew)
579c579
<             qdm_nbq_a(l_b_i)=wnbqbry_north(i,k)      ! specified
---
>             qdm_nbq_a(l_b_i,nnew)=wnbqbry_north(i,k)      ! specified
581c581
<             qdm_nbq_a(l_b_i)=wnbqclm(i,Jend+1,k)
---
>             qdm_nbq_a(l_b_i,nnew)=wnbqclm(i,Jend+1,k)
598c598
<             qdm_nbq_a(l_b_i)=qdm_nbq_a(l_bm1_i) ! gradient (default)
---
>             qdm_nbq_a(l_b_i,nnew)=qdm_nbq_a(l_bm1_i,nnew) ! gradient (default)
612c612
< !            qdm_nbq_a(l_b_i)=0.
---
> !            qdm_nbq_a(l_b_i,nnew)=0.
628,629c628,629
<           qdm_nbq_a(l_c)=0.5*(qdm_nbq_a(l_c_im1)
<      &                            +qdm_nbq_a(l_c_jm1))
---
>           qdm_nbq_a(l_c,nnew)=0.5*(qdm_nbq_a(l_c_im1,nnew)
>      &                            +qdm_nbq_a(l_c_jm1,nnew))
642,643c642,643
<           qdm_nbq_a(l_c)=0.5*(qdm_nbq_a(l_c_im1)
<      &                            +qdm_nbq_a(l_c_jm1))
---
>           qdm_nbq_a(l_c,nnew)=0.5*(qdm_nbq_a(l_c_im1,nnew)
>      &                            +qdm_nbq_a(l_c_jm1,nnew))
656,657c656,657
<           qdm_nbq_a(l_c)=0.5*(qdm_nbq_a(l_c_im1)
<      &                            +qdm_nbq_a(l_c_jm1))
---
>           qdm_nbq_a(l_c,nnew)=0.5*(qdm_nbq_a(l_c_im1,nnew)
>      &                            +qdm_nbq_a(l_c_jm1,nnew))
670,671c670,671
<           qdm_nbq_a(l_c)=0.5*(qdm_nbq_a(l_c_im1)
<      &                            +qdm_nbq_a(l_c_jm1))
---
>           qdm_nbq_a(l_c,nnew)=0.5*(qdm_nbq_a(l_c_im1,nnew)
>      &                            +qdm_nbq_a(l_c_jm1,nnew))
wnbqijk_bc.F
wrt_avg.F
wrt_bio_diags.F
wrt_bio_diags_avg.F
wrt_diags.F
wrt_diagsM.F
wrt_diagsM_avg.F
wrt_diags_avg.F
wrt_floats.F
wrt_grid.F
wrt_his.F
wrt_rst.F
wrt_sta.F
wvlcty.F
zetabc.F
zonavg.F
zoom.F
zoombc_2D.F
zoombc_3D.F
